/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { FormGroup, FormArray, FormControl, AbstractControl, Validators } from '@angular/forms';
import { FormlyConfig } from './formly.config';
import { FORMLY_VALIDATORS, evalStringExpression, evalExpressionValueSetter, getFieldId, isObject, isNullOrUndefined, clone, assignModelToFields } from './../utils';
import { getKeyPath, isFunction } from '../utils';
import { FormlyFormExpression } from './formly.form.expression';
export class FormlyFormBuilder {
    /**
     * @param {?} formlyConfig
     * @param {?} formlyFormExpression
     */
    constructor(formlyConfig, formlyFormExpression) {
        this.formlyConfig = formlyConfig;
        this.formlyFormExpression = formlyFormExpression;
        this.formId = 0;
    }
    /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} model
     * @param {?=} options
     * @return {?}
     */
    buildForm(form, fields = [], model, options) {
        let /** @type {?} */ fieldTransforms = (options && options.fieldTransform) || this.formlyConfig.extras.fieldTransform;
        if (!Array.isArray(fieldTransforms)) {
            fieldTransforms = [fieldTransforms];
        }
        fieldTransforms.forEach(fieldTransform => {
            if (fieldTransform) {
                fields = fieldTransform(fields, model, form, options);
                if (!fields) {
                    throw new Error('fieldTransform must return an array of fields');
                }
            }
        });
        assignModelToFields(fields, model);
        this._buildForm(form, fields, options);
        this.formlyFormExpression.checkFields(form, fields, model, options);
    }
    /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} options
     * @return {?}
     */
    _buildForm(form, fields = [], options) {
        this.formId++;
        this.registerFormControls(form, fields, options);
    }
    /**
     * @param {?} form
     * @param {?} fields
     * @param {?} options
     * @return {?}
     */
    registerFormControls(form, fields, options) {
        fields.forEach((field, index) => {
            field.id = getFieldId(`formly_${this.formId}`, field, index);
            this.initFieldOptions(field);
            this.initFieldExpression(field, options);
            this.initFieldValidation(field);
            this.initFieldWrappers(field);
            this.initFieldAsyncValidation(field);
            if (field.key && field.type) {
                const /** @type {?} */ paths = getKeyPath({ key: field.key });
                let /** @type {?} */ rootForm = form, /** @type {?} */ rootModel = field.model;
                paths.forEach((path, index) => {
                    // FormGroup/FormArray only allow string value for path
                    const /** @type {?} */ formPath = path.toString();
                    // is last item
                    if (index === paths.length - 1) {
                        this.addFormControl(rootForm, field, rootModel, formPath);
                        if (field.fieldArray) {
                            field.fieldGroup = [];
                            field.model.forEach((m, i) => field.fieldGroup.push(Object.assign({}, clone(field.fieldArray), { key: `${i}` })));
                            assignModelToFields(field.fieldGroup, rootModel);
                        }
                    }
                    else {
                        let /** @type {?} */ nestedForm = /** @type {?} */ (rootForm.get(formPath));
                        if (!nestedForm) {
                            nestedForm = new FormGroup({});
                            this.addControl(rootForm, formPath, nestedForm);
                        }
                        if (!rootModel[path]) {
                            rootModel[path] = typeof path === 'string' ? {} : [];
                        }
                        rootForm = nestedForm;
                        rootModel = rootModel[path];
                    }
                });
            }
            if (field.fieldGroup) {
                if (!field.type) {
                    field.type = 'formly-group';
                }
                // if `hideExpression` is set in that case we have to deal
                // with toggle FormControl for each field in fieldGroup separately
                if (field.hideExpression) {
                    field.fieldGroup.forEach(f => {
                        let /** @type {?} */ hideExpression = f.hideExpression || (() => false);
                        if (typeof hideExpression === 'string') {
                            hideExpression = evalStringExpression(hideExpression, ['model', 'formState']);
                        }
                        f.hideExpression = (model, formState) => field.hide || hideExpression(model, formState);
                    });
                }
                if (field.key) {
                    this.addFormControl(form, field, { [field.key]: field.fieldArray ? [] : {} }, field.key);
                    this._buildForm(/** @type {?} */ (field.formControl), field.fieldGroup, options);
                }
                else {
                    this._buildForm(form, field.fieldGroup, options);
                }
            }
        });
    }
    /**
     * @param {?} field
     * @param {?} options
     * @return {?}
     */
    initFieldExpression(field, options) {
        if (field.expressionProperties) {
            for (const /** @type {?} */ key in /** @type {?} */ (field.expressionProperties)) {
                if (typeof field.expressionProperties[key] === 'string' || isFunction(field.expressionProperties[key])) {
                    // cache built expression
                    field.expressionProperties[key] = {
                        expression: isFunction(field.expressionProperties[key]) ? field.expressionProperties[key] : evalStringExpression(field.expressionProperties[key], ['model', 'formState']),
                        expressionValueSetter: evalExpressionValueSetter(`field.${key}`, ['expressionValue', 'model', 'field']),
                    };
                }
            }
        }
        if (field.hideExpression) {
            // delete hide value in order to force re-evaluate it in FormlyFormExpression.
            delete field.hide;
            if (typeof field.hideExpression === 'string') {
                // cache built expression
                field.hideExpression = evalStringExpression(field.hideExpression, ['model', 'formState']);
            }
        }
    }
    /**
     * @param {?} field
     * @return {?}
     */
    initFieldOptions(field) {
        field.templateOptions = field.templateOptions || {};
        if (field.type) {
            this.formlyConfig.getMergedField(field);
            if (field.key) {
                field.templateOptions = Object.assign({
                    label: '',
                    placeholder: '',
                    focus: false,
                }, field.templateOptions);
            }
        }
    }
    /**
     * @param {?} field
     * @return {?}
     */
    initFieldAsyncValidation(field) {
        const /** @type {?} */ validators = [];
        if (field.asyncValidators) {
            for (const /** @type {?} */ validatorName in field.asyncValidators) {
                if (validatorName !== 'validation') {
                    let /** @type {?} */ validator = field.asyncValidators[validatorName];
                    if (isObject(validator)) {
                        validator = validator.expression;
                    }
                    validators.push((control) => new Promise((resolve) => {
                        return validator(control, field).then((result) => {
                            resolve(result ? null : { [validatorName]: true });
                        });
                    }));
                }
            }
        }
        if (field.asyncValidators && Array.isArray(field.asyncValidators.validation)) {
            field.asyncValidators.validation
                .forEach((validator) => validators.push(this.wrapNgValidatorFn(field, validator)));
        }
        if (validators.length) {
            if (field.asyncValidators && !Array.isArray(field.asyncValidators.validation)) {
                field.asyncValidators.validation = Validators.composeAsync([field.asyncValidators.validation, ...validators]);
            }
            else {
                field.asyncValidators = {
                    validation: Validators.composeAsync(validators),
                };
            }
        }
    }
    /**
     * @param {?} field
     * @return {?}
     */
    initFieldValidation(field) {
        const /** @type {?} */ validators = [];
        FORMLY_VALIDATORS
            .filter(opt => (field.templateOptions && field.templateOptions.hasOwnProperty(opt))
            || (field.expressionProperties && field.expressionProperties[`templateOptions.${opt}`]))
            .forEach((opt) => {
            validators.push((control) => {
                if (field.templateOptions[opt] === false) {
                    return null;
                }
                return this.getValidation(opt, field.templateOptions[opt])(control);
            });
        });
        if (field.validators) {
            for (const /** @type {?} */ validatorName in field.validators) {
                if (validatorName !== 'validation') {
                    let /** @type {?} */ validator = field.validators[validatorName];
                    let /** @type {?} */ errorPath;
                    let /** @type {?} */ message;
                    if (isObject(validator)) {
                        errorPath = validator.errorPath;
                        message = validator.message;
                        validator = validator.expression;
                    }
                    validators.push((control) => {
                        const /** @type {?} */ isValid = validator(control, field);
                        if (errorPath && field.formControl && field.formControl.get(errorPath)) {
                            if (!isValid) {
                                field.formControl.get(errorPath).setErrors(Object.assign({}, (field.formControl.get(errorPath).errors || {}), { [validatorName]: { message } }));
                            }
                            else {
                                const /** @type {?} */ errors = (field.formControl.get(errorPath).errors || {});
                                delete errors[validatorName];
                                field.formControl.get(errorPath).setErrors(Object.keys(errors).length === 0 ? null : errors);
                            }
                        }
                        return isValid ? null : { [validatorName]: errorPath ? { errorPath } : true };
                    });
                }
            }
        }
        if (field.validators && Array.isArray(field.validators.validation)) {
            field.validators.validation
                .forEach((validator) => validators.push(this.wrapNgValidatorFn(field, validator)));
        }
        if (validators.length) {
            if (field.validators && !Array.isArray(field.validators.validation)) {
                field.validators.validation = Validators.compose([field.validators.validation, ...validators]);
            }
            else {
                field.validators = {
                    validation: Validators.compose(validators),
                };
            }
        }
    }
    /**
     * @param {?} form
     * @param {?} field
     * @param {?} model
     * @param {?} path
     * @return {?}
     */
    addFormControl(form, field, model, path) {
        let /** @type {?} */ control;
        const /** @type {?} */ validators = field.validators ? field.validators.validation : undefined, /** @type {?} */
        asyncValidators = field.asyncValidators ? field.asyncValidators.validation : undefined, /** @type {?} */
        updateOn = field.modelOptions && field.modelOptions.updateOn ?
            field.modelOptions.updateOn : undefined;
        const /** @type {?} */ abstractControlOptions = /** @type {?} */ ({
            validators,
            asyncValidators,
            updateOn,
        });
        if (field.formControl instanceof AbstractControl || form.get(path)) {
            control = field.formControl || form.get(path);
            if (!(isNullOrUndefined(control.value) && isNullOrUndefined(model[path]))
                && control.value !== model[path]
                && control instanceof FormControl) {
                control.patchValue(model[path]);
            }
        }
        else if (field.component && field.component.createControl) {
            control = field.component.createControl(model[path], field);
        }
        else if (field.fieldGroup && field.key && field.key === path && !field.fieldArray) {
            control = new FormGroup(model[path], abstractControlOptions);
        }
        else if (field.fieldArray && field.key && field.key === path) {
            control = new FormArray([], abstractControlOptions);
        }
        else {
            control = new FormControl(model[path], abstractControlOptions);
        }
        if (field.templateOptions.disabled) {
            control.disable();
        }
        // Replace decorated property with a getter that returns the observable.
        // https://github.com/angular-redux/store/blob/master/src/decorators/select.ts#L79-L85
        if (delete field.templateOptions.disabled) {
            Object.defineProperty(field.templateOptions, 'disabled', {
                get: (function () { return !this.formControl.enabled; }).bind(field),
                set: (function (value) {
                    if (this.expressionProperties && this.expressionProperties.hasOwnProperty('templateOptions.disabled')) {
                        this.expressionProperties['templateOptions.disabled'].expressionValue = value;
                    }
                    value ? this.formControl.disable() : this.formControl.enable();
                }).bind(field),
                enumerable: true,
                configurable: true,
            });
        }
        this.addControl(form, path, control, field);
    }
    /**
     * @param {?} form
     * @param {?} key
     * @param {?} formControl
     * @param {?=} field
     * @return {?}
     */
    addControl(form, key, formControl, field) {
        if (field) {
            field.formControl = formControl;
        }
        if (form instanceof FormArray) {
            if (form.at(/** @type {?} */ (key)) !== formControl) {
                form.setControl(/** @type {?} */ (key), formControl);
            }
        }
        else {
            if (form.get(/** @type {?} */ (key)) !== formControl) {
                form.setControl(/** @type {?} */ (key), formControl);
            }
        }
    }
    /**
     * @param {?} opt
     * @param {?} value
     * @return {?}
     */
    getValidation(opt, value) {
        switch (opt) {
            case 'required':
                return Validators.required;
            case 'pattern':
                return Validators.pattern(value);
            case 'minLength':
                return Validators.minLength(value);
            case 'maxLength':
                return Validators.maxLength(value);
            case 'min':
                return Validators.min(value);
            case 'max':
                return Validators.max(value);
        }
    }
    /**
     * @param {?} field
     * @param {?} validator
     * @return {?}
     */
    wrapNgValidatorFn(field, validator) {
        validator = typeof validator === 'string'
            ? this.formlyConfig.getValidator(validator).validation
            : validator;
        return (control) => (/** @type {?} */ (validator))(control, field);
    }
    /**
     * @param {?} field
     * @return {?}
     */
    initFieldWrappers(field) {
        const /** @type {?} */ templateManipulators = {
            preWrapper: [],
            postWrapper: [],
        };
        if (field.templateOptions) {
            this.mergeTemplateManipulators(templateManipulators, field.templateOptions.templateManipulators);
        }
        this.mergeTemplateManipulators(templateManipulators, this.formlyConfig.templateManipulators);
        if (!field.wrappers) {
            field.wrappers = [];
        }
        const /** @type {?} */ preWrappers = templateManipulators.preWrapper
            .map(m => m(field))
            .filter(wrapper => wrapper && field.wrappers.indexOf(wrapper) === -1);
        const /** @type {?} */ postWrappers = templateManipulators.postWrapper
            .map(m => m(field))
            .filter(wrapper => wrapper && field.wrappers.indexOf(wrapper) === -1);
        field.wrappers = [...preWrappers, ...field.wrappers, ...postWrappers];
    }
    /**
     * @param {?} source
     * @param {?} target
     * @return {?}
     */
    mergeTemplateManipulators(source, target) {
        target = target || {};
        if (target.preWrapper) {
            source.preWrapper = source.preWrapper.concat(target.preWrapper);
        }
        if (target.postWrapper) {
            source.postWrapper = source.postWrapper.concat(target.postWrapper);
        }
        return source;
    }
}
FormlyFormBuilder.decorators = [
    { type: Injectable },
];
/** @nocollapse */
FormlyFormBuilder.ctorParameters = () => [
    { type: FormlyConfig },
    { type: FormlyFormExpression }
];
function FormlyFormBuilder_tsickle_Closure_declarations() {
    /** @type {?} */
    FormlyFormBuilder.prototype.formId;
    /** @type {?} */
    FormlyFormBuilder.prototype.formlyConfig;
    /** @type {?} */
    FormlyFormBuilder.prototype.formlyFormExpression;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWx5LmZvcm0uYnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3gtZm9ybWx5L2NvcmUvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvZm9ybWx5LmZvcm0uYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsZUFBZSxFQUFFLFVBQVUsRUFBMEIsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4SCxPQUFPLEVBQUUsWUFBWSxFQUEwQyxNQUFNLGlCQUFpQixDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxvQkFBb0IsRUFBRSx5QkFBeUIsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLGlCQUFpQixFQUFFLEtBQUssRUFBRSxtQkFBbUIsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUVySyxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNsRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUdoRSxNQUFNOzs7OztJQUdKLFlBQ1UsY0FDQTtRQURBLGlCQUFZLEdBQVosWUFBWTtRQUNaLHlCQUFvQixHQUFwQixvQkFBb0I7c0JBSmIsQ0FBQztLQUtkOzs7Ozs7OztJQUVKLFNBQVMsQ0FBQyxJQUEyQixFQUFFLFNBQThCLEVBQUUsRUFBRSxLQUFVLEVBQUUsT0FBMEI7UUFDN0cscUJBQUksZUFBZSxHQUFHLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxjQUFjLENBQUMsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUM7UUFDckcsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwQyxlQUFlLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztTQUNyQztRQUVELGVBQWUsQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEVBQUU7WUFDdkMsRUFBRSxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztnQkFDbkIsTUFBTSxHQUFHLGNBQWMsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztnQkFDdEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO29CQUNaLE1BQU0sSUFBSSxLQUFLLENBQUMsK0NBQStDLENBQUMsQ0FBQztpQkFDbEU7YUFDRjtTQUNGLENBQUMsQ0FBQztRQUVILG1CQUFtQixDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztLQUNyRTs7Ozs7OztJQUVPLFVBQVUsQ0FBQyxJQUEyQixFQUFFLFNBQThCLEVBQUUsRUFBRSxPQUEwQjtRQUMxRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDZCxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQzs7Ozs7Ozs7SUFHM0Msb0JBQW9CLENBQUMsSUFBMkIsRUFBRSxNQUEyQixFQUFFLE9BQTBCO1FBQy9HLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDOUIsS0FBSyxDQUFDLEVBQUUsR0FBRyxVQUFVLENBQUMsVUFBVSxJQUFJLENBQUMsTUFBTSxFQUFFLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzdELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUM3QixJQUFJLENBQUMsbUJBQW1CLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ3pDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNoQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDOUIsSUFBSSxDQUFDLHdCQUF3QixDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXJDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBQzVCLHVCQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQzdDLHFCQUFJLFFBQVEsR0FBRyxJQUFJLG1CQUFFLFNBQVMsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDO2dCQUM3QyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFOztvQkFFNUIsdUJBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQzs7b0JBRWpDLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQy9CLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUM7d0JBQzFELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDOzRCQUNyQixLQUFLLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQzs0QkFDdEIsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFNLEVBQUUsQ0FBUyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksbUJBQ3pELEtBQUssQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxFQUFFLElBQzFDLENBQUMsQ0FBQzs0QkFDSCxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDO3lCQUNsRDtxQkFFRjtvQkFBQyxJQUFJLENBQUMsQ0FBQzt3QkFDTixxQkFBSSxVQUFVLHFCQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFjLENBQUEsQ0FBQzt3QkFDckQsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDOzRCQUNoQixVQUFVLEdBQUcsSUFBSSxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7NEJBQy9CLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQzt5QkFDakQ7d0JBQ0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDOzRCQUNyQixTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsT0FBTyxJQUFJLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQzt5QkFDdEQ7d0JBRUQsUUFBUSxHQUFHLFVBQVUsQ0FBQzt3QkFDdEIsU0FBUyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztxQkFDN0I7aUJBQ0YsQ0FBQyxDQUFDO2FBQ0o7WUFFRCxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDckIsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztvQkFDaEIsS0FBSyxDQUFDLElBQUksR0FBRyxjQUFjLENBQUM7aUJBQzdCOzs7Z0JBSUQsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7b0JBQ3pCLEtBQUssQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO3dCQUMzQixxQkFBSSxjQUFjLEdBQVEsQ0FBQyxDQUFDLGNBQWMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO3dCQUM1RCxFQUFFLENBQUMsQ0FBQyxPQUFPLGNBQWMsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDOzRCQUN2QyxjQUFjLEdBQUcsb0JBQW9CLENBQUMsY0FBYyxFQUFFLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUM7eUJBQy9FO3dCQUVELENBQUMsQ0FBQyxjQUFjLEdBQUcsQ0FBQyxLQUFLLEVBQUUsU0FBUyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLGNBQWMsQ0FBQyxLQUFLLEVBQUUsU0FBUyxDQUFDLENBQUM7cUJBQ3pGLENBQUMsQ0FBQztpQkFDSjtnQkFFRCxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDZCxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDekYsSUFBSSxDQUFDLFVBQVUsbUJBQUMsS0FBSyxDQUFDLFdBQXdCLEdBQUUsS0FBSyxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztpQkFDNUU7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ04sSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztpQkFDbEQ7YUFDRjtTQUNGLENBQUMsQ0FBQzs7Ozs7OztJQUdHLG1CQUFtQixDQUFDLEtBQXdCLEVBQUUsT0FBMEI7UUFDOUUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQztZQUMvQixHQUFHLENBQUMsQ0FBQyx1QkFBTSxHQUFHLHNCQUFJLEtBQUssQ0FBQyxvQkFBMkIsR0FBRSxDQUFDO2dCQUNwRCxFQUFFLENBQUMsQ0FBQyxPQUFPLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsS0FBSyxRQUFRLElBQUksVUFBVSxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzs7b0JBRXZHLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsR0FBRzt3QkFDaEMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxLQUFLLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDLENBQUM7d0JBQ3pLLHFCQUFxQixFQUFFLHlCQUF5QixDQUM5QyxTQUFTLEdBQUcsRUFBRSxFQUNkLENBQUMsaUJBQWlCLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUN0QztxQkFDRixDQUFDO2lCQUNIO2FBQ0Y7U0FDRjtRQUVELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDOztZQUV6QixPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUM7WUFDbEIsRUFBRSxDQUFDLENBQUMsT0FBTyxLQUFLLENBQUMsY0FBYyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7O2dCQUU3QyxLQUFLLENBQUMsY0FBYyxHQUFHLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQzthQUMzRjtTQUNGOzs7Ozs7SUFHSyxnQkFBZ0IsQ0FBQyxLQUF3QjtRQUMvQyxLQUFLLENBQUMsZUFBZSxHQUFHLEtBQUssQ0FBQyxlQUFlLElBQUksRUFBRSxDQUFDO1FBQ3BELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2YsSUFBSSxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDeEMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ2QsS0FBSyxDQUFDLGVBQWUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO29CQUNwQyxLQUFLLEVBQUUsRUFBRTtvQkFDVCxXQUFXLEVBQUUsRUFBRTtvQkFDZixLQUFLLEVBQUUsS0FBSztpQkFDYixFQUFFLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQzthQUMzQjtTQUNGOzs7Ozs7SUFHSyx3QkFBd0IsQ0FBQyxLQUF3QjtRQUN2RCx1QkFBTSxVQUFVLEdBQVEsRUFBRSxDQUFDO1FBQzNCLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO1lBQzFCLEdBQUcsQ0FBQyxDQUFDLHVCQUFNLGFBQWEsSUFBSSxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztnQkFDbEQsRUFBRSxDQUFDLENBQUMsYUFBYSxLQUFLLFlBQVksQ0FBQyxDQUFDLENBQUM7b0JBQ25DLHFCQUFJLFNBQVMsR0FBRyxLQUFLLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxDQUFDO29CQUNyRCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUN4QixTQUFTLEdBQUcsU0FBUyxDQUFDLFVBQVUsQ0FBQztxQkFDbEM7b0JBRUQsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQW9CLEVBQUUsRUFBRSxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUU7d0JBQ2hFLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQWUsRUFBRSxFQUFFOzRCQUN4RCxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO3lCQUNwRCxDQUFDLENBQUM7cUJBQ0osQ0FBQyxDQUFDLENBQUM7aUJBQ0w7YUFDRjtTQUNGO1FBRUQsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLGVBQWUsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdFLEtBQUssQ0FBQyxlQUFlLENBQUMsVUFBVTtpQkFDN0IsT0FBTyxDQUFDLENBQUMsU0FBYyxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzNGO1FBRUQsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDdEIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLGVBQWUsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzlFLEtBQUssQ0FBQyxlQUFlLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLFVBQVUsRUFBRSxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUM7YUFDL0c7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixLQUFLLENBQUMsZUFBZSxHQUFHO29CQUN0QixVQUFVLEVBQUUsVUFBVSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUM7aUJBQ2hELENBQUM7YUFDSDtTQUNGOzs7Ozs7SUFHSyxtQkFBbUIsQ0FBQyxLQUF3QjtRQUNsRCx1QkFBTSxVQUFVLEdBQVEsRUFBRSxDQUFDO1FBQzNCLGlCQUFpQjthQUNkLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLGVBQWUsSUFBSSxLQUFLLENBQUMsZUFBZSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQztlQUM5RSxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsSUFBSSxLQUFLLENBQUMsb0JBQW9CLENBQUMsbUJBQW1CLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FDeEY7YUFDQSxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNmLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFvQixFQUFFLEVBQUU7Z0JBQ3ZDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQztvQkFDekMsTUFBTSxDQUFDLElBQUksQ0FBQztpQkFDYjtnQkFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3JFLENBQUMsQ0FBQztTQUNKLENBQUMsQ0FBQztRQUVMLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLEdBQUcsQ0FBQyxDQUFDLHVCQUFNLGFBQWEsSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDN0MsRUFBRSxDQUFDLENBQUMsYUFBYSxLQUFLLFlBQVksQ0FBQyxDQUFDLENBQUM7b0JBQ25DLHFCQUFJLFNBQVMsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFDO29CQUNoRCxxQkFBSSxTQUFTLENBQUM7b0JBQ2QscUJBQUksT0FBTyxDQUFDO29CQUNaLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ3hCLFNBQVMsR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDO3dCQUNoQyxPQUFPLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQzt3QkFDNUIsU0FBUyxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUM7cUJBQ2xDO29CQUVELFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFvQixFQUFFLEVBQUU7d0JBQ3ZDLHVCQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO3dCQUMxQyxFQUFFLENBQUMsQ0FBQyxTQUFTLElBQUksS0FBSyxDQUFDLFdBQVcsSUFBSSxLQUFLLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7NEJBQ3ZFLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztnQ0FDYixLQUFLLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxTQUFTLG1CQUNyQyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsSUFDbEQsQ0FBQyxhQUFhLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUM1QixDQUFDOzZCQUNKOzRCQUFDLElBQUksQ0FBQyxDQUFDO2dDQUNOLHVCQUFNLE1BQU0sR0FBRyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsQ0FBQztnQ0FDL0QsT0FBTyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7Z0NBQzdCLEtBQUssQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7NkJBQzlGO3lCQUNGO3dCQUVELE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7cUJBQy9FLENBQUMsQ0FBQztpQkFDSjthQUNGO1NBQ0Y7UUFFRCxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkUsS0FBSyxDQUFDLFVBQVUsQ0FBQyxVQUFVO2lCQUN4QixPQUFPLENBQUMsQ0FBQyxTQUFjLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDM0Y7UUFFRCxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUN0QixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDcEUsS0FBSyxDQUFDLFVBQVUsQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsVUFBVSxFQUFFLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQzthQUNoRztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLEtBQUssQ0FBQyxVQUFVLEdBQUc7b0JBQ2pCLFVBQVUsRUFBRSxVQUFVLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQztpQkFDM0MsQ0FBQzthQUNIO1NBQ0Y7Ozs7Ozs7OztJQUdLLGNBQWMsQ0FBQyxJQUEyQixFQUFFLEtBQXdCLEVBQUUsS0FBVSxFQUFFLElBQVk7UUFDcEcscUJBQUksT0FBd0IsQ0FBQztRQUM3Qix1QkFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLFNBQVM7UUFDM0UsZUFBZSxHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxTQUFTO1FBQ3RGLFFBQVEsR0FBRyxLQUFLLENBQUMsWUFBWSxJQUFJLEtBQUssQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDNUQsS0FBSyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUM1Qyx1QkFBTSxzQkFBc0IscUJBQUc7WUFDN0IsVUFBVTtZQUNWLGVBQWU7WUFDZixRQUFRO1NBQ2lCLENBQUEsQ0FBQztRQUU1QixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsV0FBVyxZQUFZLGVBQWUsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuRSxPQUFPLEdBQUcsS0FBSyxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzlDLEVBQUUsQ0FBQyxDQUNELENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksaUJBQWlCLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7bUJBQ2xFLE9BQU8sQ0FBQyxLQUFLLEtBQUssS0FBSyxDQUFDLElBQUksQ0FBQzttQkFDN0IsT0FBTyxZQUFZLFdBQ3hCLENBQUMsQ0FBQyxDQUFDO2dCQUNELE9BQU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7YUFDakM7U0FDRjtRQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsU0FBUyxJQUFJLEtBQUssQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztZQUM1RCxPQUFPLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQzdEO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLElBQUksS0FBSyxDQUFDLEdBQUcsSUFBSSxLQUFLLENBQUMsR0FBRyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBQ3BGLE9BQU8sR0FBRyxJQUFJLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztTQUM5RDtRQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxJQUFJLEtBQUssQ0FBQyxHQUFHLElBQUksS0FBSyxDQUFDLEdBQUcsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQy9ELE9BQU8sR0FBRyxJQUFJLFNBQVMsQ0FBQyxFQUFFLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztTQUNyRDtRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sT0FBTyxHQUFHLElBQUksV0FBVyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO1NBQ2hFO1FBRUQsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ25DLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUNuQjs7O1FBSUQsRUFBRSxDQUFDLENBQUMsT0FBTyxLQUFLLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDMUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFLFVBQVUsRUFBRTtnQkFDdkQsR0FBRyxFQUFFLENBQUMsY0FBYyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO2dCQUNwRSxHQUFHLEVBQUUsQ0FBQyxVQUFVLEtBQWM7b0JBQzVCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsSUFBSSxJQUFJLENBQUMsb0JBQW9CLENBQUMsY0FBYyxDQUFDLDBCQUEwQixDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUN0RyxJQUFJLENBQUMsb0JBQW9CLENBQUMsMEJBQTBCLENBQUMsQ0FBQyxlQUFlLEdBQUcsS0FBSyxDQUFDO3FCQUMvRTtvQkFFRCxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUM7aUJBQ2hFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO2dCQUNkLFVBQVUsRUFBRSxJQUFJO2dCQUNoQixZQUFZLEVBQUUsSUFBSTthQUNuQixDQUFDLENBQUM7U0FDSjtRQUVELElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7Ozs7Ozs7OztJQUd0QyxVQUFVLENBQUMsSUFBMkIsRUFBRSxHQUFvQixFQUFFLFdBQTRCLEVBQUUsS0FBeUI7UUFDM0gsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNWLEtBQUssQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1NBQ2pDO1FBRUQsRUFBRSxDQUFDLENBQUMsSUFBSSxZQUFZLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDOUIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsbUJBQVUsR0FBRyxFQUFDLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQztnQkFDMUMsSUFBSSxDQUFDLFVBQVUsbUJBQVMsR0FBRyxHQUFFLFdBQVcsQ0FBQyxDQUFDO2FBQzNDO1NBQ0Y7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLG1CQUFVLEdBQUcsRUFBQyxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUM7Z0JBQzNDLElBQUksQ0FBQyxVQUFVLG1CQUFTLEdBQUcsR0FBRSxXQUFXLENBQUMsQ0FBQzthQUMzQztTQUNGOzs7Ozs7O0lBR0ssYUFBYSxDQUFDLEdBQVcsRUFBRSxLQUFVO1FBQzNDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDWixLQUFLLFVBQVU7Z0JBQ2IsTUFBTSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUM7WUFDN0IsS0FBSyxTQUFTO2dCQUNaLE1BQU0sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ25DLEtBQUssV0FBVztnQkFDZCxNQUFNLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNyQyxLQUFLLFdBQVc7Z0JBQ2QsTUFBTSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDckMsS0FBSyxLQUFLO2dCQUNSLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9CLEtBQUssS0FBSztnQkFDUixNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNoQzs7Ozs7OztJQUdLLGlCQUFpQixDQUFDLEtBQXdCLEVBQUUsU0FBb0M7UUFDdEYsU0FBUyxHQUFHLE9BQU8sU0FBUyxLQUFLLFFBQVE7WUFDekMsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFVBQVU7WUFDdEQsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUVaLE1BQU0sQ0FBQyxDQUFDLE9BQXdCLEVBQUUsRUFBRSxDQUFDLG1CQUFDLFNBQTZCLEVBQUMsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7Ozs7OztJQUcvRSxpQkFBaUIsQ0FBQyxLQUF3QjtRQUNoRCx1QkFBTSxvQkFBb0IsR0FBeUI7WUFDakQsVUFBVSxFQUFFLEVBQUU7WUFDZCxXQUFXLEVBQUUsRUFBRTtTQUNoQixDQUFDO1FBRUYsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7WUFDMUIsSUFBSSxDQUFDLHlCQUF5QixDQUFDLG9CQUFvQixFQUFFLEtBQUssQ0FBQyxlQUFlLENBQUMsb0JBQW9CLENBQUMsQ0FBQztTQUNsRztRQUVELElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxvQkFBb0IsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDN0YsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUNwQixLQUFLLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztTQUNyQjtRQUVELHVCQUFNLFdBQVcsR0FBRyxvQkFBb0IsQ0FBQyxVQUFVO2FBQ2hELEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNsQixNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUV4RSx1QkFBTSxZQUFZLEdBQUcsb0JBQW9CLENBQUMsV0FBVzthQUNsRCxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDbEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFeEUsS0FBSyxDQUFDLFFBQVEsR0FBRyxDQUFDLEdBQUcsV0FBVyxFQUFFLEdBQUcsS0FBSyxDQUFDLFFBQVEsRUFBRSxHQUFHLFlBQVksQ0FBQyxDQUFDOzs7Ozs7O0lBR2hFLHlCQUF5QixDQUFDLE1BQTRCLEVBQUUsTUFBNEI7UUFDMUYsTUFBTSxHQUFHLE1BQU0sSUFBSSxFQUFFLENBQUM7UUFDdEIsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDdEIsTUFBTSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDakU7UUFDRCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztZQUN2QixNQUFNLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUNwRTtRQUVELE1BQU0sQ0FBQyxNQUFNLENBQUM7Ozs7WUF2WGpCLFVBQVU7Ozs7WUFORixZQUFZO1lBSVosb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybUdyb3VwLCBGb3JtQXJyYXksIEZvcm1Db250cm9sLCBBYnN0cmFjdENvbnRyb2wsIFZhbGlkYXRvcnMsIEFic3RyYWN0Q29udHJvbE9wdGlvbnMgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBGb3JtbHlDb25maWcsIEZpZWxkVmFsaWRhdG9yRm4sIFRlbXBsYXRlTWFuaXB1bGF0b3JzIH0gZnJvbSAnLi9mb3JtbHkuY29uZmlnJztcbmltcG9ydCB7IEZPUk1MWV9WQUxJREFUT1JTLCBldmFsU3RyaW5nRXhwcmVzc2lvbiwgZXZhbEV4cHJlc3Npb25WYWx1ZVNldHRlciwgZ2V0RmllbGRJZCwgaXNPYmplY3QsIGlzTnVsbE9yVW5kZWZpbmVkLCBjbG9uZSwgYXNzaWduTW9kZWxUb0ZpZWxkcyB9IGZyb20gJy4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgRm9ybWx5RmllbGRDb25maWcsIEZvcm1seUZvcm1PcHRpb25zIH0gZnJvbSAnLi4vY29tcG9uZW50cy9mb3JtbHkuZmllbGQuY29uZmlnJztcbmltcG9ydCB7IGdldEtleVBhdGgsIGlzRnVuY3Rpb24gfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyBGb3JtbHlGb3JtRXhwcmVzc2lvbiB9IGZyb20gJy4vZm9ybWx5LmZvcm0uZXhwcmVzc2lvbic7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBGb3JtbHlGb3JtQnVpbGRlciB7XG4gIHByaXZhdGUgZm9ybUlkID0gMDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGZvcm1seUNvbmZpZzogRm9ybWx5Q29uZmlnLFxuICAgIHByaXZhdGUgZm9ybWx5Rm9ybUV4cHJlc3Npb246IEZvcm1seUZvcm1FeHByZXNzaW9uLFxuICApIHt9XG5cbiAgYnVpbGRGb3JtKGZvcm06IEZvcm1Hcm91cCB8IEZvcm1BcnJheSwgZmllbGRzOiBGb3JtbHlGaWVsZENvbmZpZ1tdID0gW10sIG1vZGVsOiBhbnksIG9wdGlvbnM6IEZvcm1seUZvcm1PcHRpb25zKSB7XG4gICAgbGV0IGZpZWxkVHJhbnNmb3JtcyA9IChvcHRpb25zICYmIG9wdGlvbnMuZmllbGRUcmFuc2Zvcm0pIHx8IHRoaXMuZm9ybWx5Q29uZmlnLmV4dHJhcy5maWVsZFRyYW5zZm9ybTtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZmllbGRUcmFuc2Zvcm1zKSkge1xuICAgICAgZmllbGRUcmFuc2Zvcm1zID0gW2ZpZWxkVHJhbnNmb3Jtc107XG4gICAgfVxuXG4gICAgZmllbGRUcmFuc2Zvcm1zLmZvckVhY2goZmllbGRUcmFuc2Zvcm0gPT4ge1xuICAgICAgaWYgKGZpZWxkVHJhbnNmb3JtKSB7XG4gICAgICAgIGZpZWxkcyA9IGZpZWxkVHJhbnNmb3JtKGZpZWxkcywgbW9kZWwsIGZvcm0sIG9wdGlvbnMpO1xuICAgICAgICBpZiAoIWZpZWxkcykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignZmllbGRUcmFuc2Zvcm0gbXVzdCByZXR1cm4gYW4gYXJyYXkgb2YgZmllbGRzJyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGFzc2lnbk1vZGVsVG9GaWVsZHMoZmllbGRzLCBtb2RlbCk7XG4gICAgdGhpcy5fYnVpbGRGb3JtKGZvcm0sIGZpZWxkcywgb3B0aW9ucyk7XG4gICAgdGhpcy5mb3JtbHlGb3JtRXhwcmVzc2lvbi5jaGVja0ZpZWxkcyhmb3JtLCBmaWVsZHMsIG1vZGVsLCBvcHRpb25zKTtcbiAgfVxuXG4gIHByaXZhdGUgX2J1aWxkRm9ybShmb3JtOiBGb3JtR3JvdXAgfCBGb3JtQXJyYXksIGZpZWxkczogRm9ybWx5RmllbGRDb25maWdbXSA9IFtdLCBvcHRpb25zOiBGb3JtbHlGb3JtT3B0aW9ucykge1xuICAgIHRoaXMuZm9ybUlkKys7XG4gICAgdGhpcy5yZWdpc3RlckZvcm1Db250cm9scyhmb3JtLCBmaWVsZHMsIG9wdGlvbnMpO1xuICB9XG5cbiAgcHJpdmF0ZSByZWdpc3RlckZvcm1Db250cm9scyhmb3JtOiBGb3JtR3JvdXAgfCBGb3JtQXJyYXksIGZpZWxkczogRm9ybWx5RmllbGRDb25maWdbXSwgb3B0aW9uczogRm9ybWx5Rm9ybU9wdGlvbnMpIHtcbiAgICBmaWVsZHMuZm9yRWFjaCgoZmllbGQsIGluZGV4KSA9PiB7XG4gICAgICBmaWVsZC5pZCA9IGdldEZpZWxkSWQoYGZvcm1seV8ke3RoaXMuZm9ybUlkfWAsIGZpZWxkLCBpbmRleCk7XG4gICAgICB0aGlzLmluaXRGaWVsZE9wdGlvbnMoZmllbGQpO1xuICAgICAgdGhpcy5pbml0RmllbGRFeHByZXNzaW9uKGZpZWxkLCBvcHRpb25zKTtcbiAgICAgIHRoaXMuaW5pdEZpZWxkVmFsaWRhdGlvbihmaWVsZCk7XG4gICAgICB0aGlzLmluaXRGaWVsZFdyYXBwZXJzKGZpZWxkKTtcbiAgICAgIHRoaXMuaW5pdEZpZWxkQXN5bmNWYWxpZGF0aW9uKGZpZWxkKTtcblxuICAgICAgaWYgKGZpZWxkLmtleSAmJiBmaWVsZC50eXBlKSB7XG4gICAgICAgIGNvbnN0IHBhdGhzID0gZ2V0S2V5UGF0aCh7IGtleTogZmllbGQua2V5IH0pO1xuICAgICAgICBsZXQgcm9vdEZvcm0gPSBmb3JtLCByb290TW9kZWwgPSBmaWVsZC5tb2RlbDtcbiAgICAgICAgcGF0aHMuZm9yRWFjaCgocGF0aCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAvLyBGb3JtR3JvdXAvRm9ybUFycmF5IG9ubHkgYWxsb3cgc3RyaW5nIHZhbHVlIGZvciBwYXRoXG4gICAgICAgICAgY29uc3QgZm9ybVBhdGggPSBwYXRoLnRvU3RyaW5nKCk7XG4gICAgICAgICAgLy8gaXMgbGFzdCBpdGVtXG4gICAgICAgICAgaWYgKGluZGV4ID09PSBwYXRocy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICB0aGlzLmFkZEZvcm1Db250cm9sKHJvb3RGb3JtLCBmaWVsZCwgcm9vdE1vZGVsLCBmb3JtUGF0aCk7XG4gICAgICAgICAgICBpZiAoZmllbGQuZmllbGRBcnJheSkge1xuICAgICAgICAgICAgICBmaWVsZC5maWVsZEdyb3VwID0gW107XG4gICAgICAgICAgICAgIGZpZWxkLm1vZGVsLmZvckVhY2goKG06IGFueSwgaTogbnVtYmVyKSA9PiBmaWVsZC5maWVsZEdyb3VwLnB1c2goXG4gICAgICAgICAgICAgICAgeyAuLi5jbG9uZShmaWVsZC5maWVsZEFycmF5KSwga2V5OiBgJHtpfWAgfSxcbiAgICAgICAgICAgICAgKSk7XG4gICAgICAgICAgICAgIGFzc2lnbk1vZGVsVG9GaWVsZHMoZmllbGQuZmllbGRHcm91cCwgcm9vdE1vZGVsKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgbmVzdGVkRm9ybSA9IHJvb3RGb3JtLmdldChmb3JtUGF0aCkgYXMgRm9ybUdyb3VwO1xuICAgICAgICAgICAgaWYgKCFuZXN0ZWRGb3JtKSB7XG4gICAgICAgICAgICAgIG5lc3RlZEZvcm0gPSBuZXcgRm9ybUdyb3VwKHt9KTtcbiAgICAgICAgICAgICAgdGhpcy5hZGRDb250cm9sKHJvb3RGb3JtLCBmb3JtUGF0aCwgbmVzdGVkRm9ybSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXJvb3RNb2RlbFtwYXRoXSkge1xuICAgICAgICAgICAgICByb290TW9kZWxbcGF0aF0gPSB0eXBlb2YgcGF0aCA9PT0gJ3N0cmluZycgPyB7fSA6IFtdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByb290Rm9ybSA9IG5lc3RlZEZvcm07XG4gICAgICAgICAgICByb290TW9kZWwgPSByb290TW9kZWxbcGF0aF07XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKGZpZWxkLmZpZWxkR3JvdXApIHtcbiAgICAgICAgaWYgKCFmaWVsZC50eXBlKSB7XG4gICAgICAgICAgZmllbGQudHlwZSA9ICdmb3JtbHktZ3JvdXAnO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gaWYgYGhpZGVFeHByZXNzaW9uYCBpcyBzZXQgaW4gdGhhdCBjYXNlIHdlIGhhdmUgdG8gZGVhbFxuICAgICAgICAvLyB3aXRoIHRvZ2dsZSBGb3JtQ29udHJvbCBmb3IgZWFjaCBmaWVsZCBpbiBmaWVsZEdyb3VwIHNlcGFyYXRlbHlcbiAgICAgICAgaWYgKGZpZWxkLmhpZGVFeHByZXNzaW9uKSB7XG4gICAgICAgICAgZmllbGQuZmllbGRHcm91cC5mb3JFYWNoKGYgPT4ge1xuICAgICAgICAgICAgbGV0IGhpZGVFeHByZXNzaW9uOiBhbnkgPSBmLmhpZGVFeHByZXNzaW9uIHx8ICgoKSA9PiBmYWxzZSk7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGhpZGVFeHByZXNzaW9uID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICBoaWRlRXhwcmVzc2lvbiA9IGV2YWxTdHJpbmdFeHByZXNzaW9uKGhpZGVFeHByZXNzaW9uLCBbJ21vZGVsJywgJ2Zvcm1TdGF0ZSddKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZi5oaWRlRXhwcmVzc2lvbiA9IChtb2RlbCwgZm9ybVN0YXRlKSA9PiBmaWVsZC5oaWRlIHx8IGhpZGVFeHByZXNzaW9uKG1vZGVsLCBmb3JtU3RhdGUpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZpZWxkLmtleSkge1xuICAgICAgICAgIHRoaXMuYWRkRm9ybUNvbnRyb2woZm9ybSwgZmllbGQsIHsgW2ZpZWxkLmtleV06IGZpZWxkLmZpZWxkQXJyYXkgPyBbXSA6IHt9IH0sIGZpZWxkLmtleSk7XG4gICAgICAgICAgdGhpcy5fYnVpbGRGb3JtKGZpZWxkLmZvcm1Db250cm9sIGFzIEZvcm1Hcm91cCwgZmllbGQuZmllbGRHcm91cCwgb3B0aW9ucyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5fYnVpbGRGb3JtKGZvcm0sIGZpZWxkLmZpZWxkR3JvdXAsIG9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGluaXRGaWVsZEV4cHJlc3Npb24oZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnLCBvcHRpb25zOiBGb3JtbHlGb3JtT3B0aW9ucykge1xuICAgIGlmIChmaWVsZC5leHByZXNzaW9uUHJvcGVydGllcykge1xuICAgICAgZm9yIChjb25zdCBrZXkgaW4gZmllbGQuZXhwcmVzc2lvblByb3BlcnRpZXMgYXMgYW55KSB7XG4gICAgICAgIGlmICh0eXBlb2YgZmllbGQuZXhwcmVzc2lvblByb3BlcnRpZXNba2V5XSA9PT0gJ3N0cmluZycgfHwgaXNGdW5jdGlvbihmaWVsZC5leHByZXNzaW9uUHJvcGVydGllc1trZXldKSkge1xuICAgICAgICAgIC8vIGNhY2hlIGJ1aWx0IGV4cHJlc3Npb25cbiAgICAgICAgICBmaWVsZC5leHByZXNzaW9uUHJvcGVydGllc1trZXldID0ge1xuICAgICAgICAgICAgZXhwcmVzc2lvbjogaXNGdW5jdGlvbihmaWVsZC5leHByZXNzaW9uUHJvcGVydGllc1trZXldKSA/IGZpZWxkLmV4cHJlc3Npb25Qcm9wZXJ0aWVzW2tleV0gOiBldmFsU3RyaW5nRXhwcmVzc2lvbihmaWVsZC5leHByZXNzaW9uUHJvcGVydGllc1trZXldLCBbJ21vZGVsJywgJ2Zvcm1TdGF0ZSddKSxcbiAgICAgICAgICAgIGV4cHJlc3Npb25WYWx1ZVNldHRlcjogZXZhbEV4cHJlc3Npb25WYWx1ZVNldHRlcihcbiAgICAgICAgICAgICAgYGZpZWxkLiR7a2V5fWAsXG4gICAgICAgICAgICAgIFsnZXhwcmVzc2lvblZhbHVlJywgJ21vZGVsJywgJ2ZpZWxkJ10sXG4gICAgICAgICAgICApLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoZmllbGQuaGlkZUV4cHJlc3Npb24pIHtcbiAgICAgIC8vIGRlbGV0ZSBoaWRlIHZhbHVlIGluIG9yZGVyIHRvIGZvcmNlIHJlLWV2YWx1YXRlIGl0IGluIEZvcm1seUZvcm1FeHByZXNzaW9uLlxuICAgICAgZGVsZXRlIGZpZWxkLmhpZGU7XG4gICAgICBpZiAodHlwZW9mIGZpZWxkLmhpZGVFeHByZXNzaW9uID09PSAnc3RyaW5nJykge1xuICAgICAgICAvLyBjYWNoZSBidWlsdCBleHByZXNzaW9uXG4gICAgICAgIGZpZWxkLmhpZGVFeHByZXNzaW9uID0gZXZhbFN0cmluZ0V4cHJlc3Npb24oZmllbGQuaGlkZUV4cHJlc3Npb24sIFsnbW9kZWwnLCAnZm9ybVN0YXRlJ10pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaW5pdEZpZWxkT3B0aW9ucyhmaWVsZDogRm9ybWx5RmllbGRDb25maWcpIHtcbiAgICBmaWVsZC50ZW1wbGF0ZU9wdGlvbnMgPSBmaWVsZC50ZW1wbGF0ZU9wdGlvbnMgfHwge307XG4gICAgaWYgKGZpZWxkLnR5cGUpIHtcbiAgICAgIHRoaXMuZm9ybWx5Q29uZmlnLmdldE1lcmdlZEZpZWxkKGZpZWxkKTtcbiAgICAgIGlmIChmaWVsZC5rZXkpIHtcbiAgICAgICAgZmllbGQudGVtcGxhdGVPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7XG4gICAgICAgICAgbGFiZWw6ICcnLFxuICAgICAgICAgIHBsYWNlaG9sZGVyOiAnJyxcbiAgICAgICAgICBmb2N1czogZmFsc2UsXG4gICAgICAgIH0sIGZpZWxkLnRlbXBsYXRlT3B0aW9ucyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0RmllbGRBc3luY1ZhbGlkYXRpb24oZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnKSB7XG4gICAgY29uc3QgdmFsaWRhdG9yczogYW55ID0gW107XG4gICAgaWYgKGZpZWxkLmFzeW5jVmFsaWRhdG9ycykge1xuICAgICAgZm9yIChjb25zdCB2YWxpZGF0b3JOYW1lIGluIGZpZWxkLmFzeW5jVmFsaWRhdG9ycykge1xuICAgICAgICBpZiAodmFsaWRhdG9yTmFtZSAhPT0gJ3ZhbGlkYXRpb24nKSB7XG4gICAgICAgICAgbGV0IHZhbGlkYXRvciA9IGZpZWxkLmFzeW5jVmFsaWRhdG9yc1t2YWxpZGF0b3JOYW1lXTtcbiAgICAgICAgICBpZiAoaXNPYmplY3QodmFsaWRhdG9yKSkge1xuICAgICAgICAgICAgdmFsaWRhdG9yID0gdmFsaWRhdG9yLmV4cHJlc3Npb247XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdmFsaWRhdG9ycy5wdXNoKChjb250cm9sOiBGb3JtQ29udHJvbCkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB2YWxpZGF0b3IoY29udHJvbCwgZmllbGQpLnRoZW4oKHJlc3VsdDogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCA/IG51bGwgOiB7IFt2YWxpZGF0b3JOYW1lXTogdHJ1ZSB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChmaWVsZC5hc3luY1ZhbGlkYXRvcnMgJiYgQXJyYXkuaXNBcnJheShmaWVsZC5hc3luY1ZhbGlkYXRvcnMudmFsaWRhdGlvbikpIHtcbiAgICAgIGZpZWxkLmFzeW5jVmFsaWRhdG9ycy52YWxpZGF0aW9uXG4gICAgICAgIC5mb3JFYWNoKCh2YWxpZGF0b3I6IGFueSkgPT4gdmFsaWRhdG9ycy5wdXNoKHRoaXMud3JhcE5nVmFsaWRhdG9yRm4oZmllbGQsIHZhbGlkYXRvcikpKTtcbiAgICB9XG5cbiAgICBpZiAodmFsaWRhdG9ycy5sZW5ndGgpIHtcbiAgICAgIGlmIChmaWVsZC5hc3luY1ZhbGlkYXRvcnMgJiYgIUFycmF5LmlzQXJyYXkoZmllbGQuYXN5bmNWYWxpZGF0b3JzLnZhbGlkYXRpb24pKSB7XG4gICAgICAgIGZpZWxkLmFzeW5jVmFsaWRhdG9ycy52YWxpZGF0aW9uID0gVmFsaWRhdG9ycy5jb21wb3NlQXN5bmMoW2ZpZWxkLmFzeW5jVmFsaWRhdG9ycy52YWxpZGF0aW9uLCAuLi52YWxpZGF0b3JzXSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmaWVsZC5hc3luY1ZhbGlkYXRvcnMgPSB7XG4gICAgICAgICAgdmFsaWRhdGlvbjogVmFsaWRhdG9ycy5jb21wb3NlQXN5bmModmFsaWRhdG9ycyksXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0RmllbGRWYWxpZGF0aW9uKGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZykge1xuICAgIGNvbnN0IHZhbGlkYXRvcnM6IGFueSA9IFtdO1xuICAgIEZPUk1MWV9WQUxJREFUT1JTXG4gICAgICAuZmlsdGVyKG9wdCA9PiAoZmllbGQudGVtcGxhdGVPcHRpb25zICYmIGZpZWxkLnRlbXBsYXRlT3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShvcHQpKVxuICAgICAgICB8fCAoZmllbGQuZXhwcmVzc2lvblByb3BlcnRpZXMgJiYgZmllbGQuZXhwcmVzc2lvblByb3BlcnRpZXNbYHRlbXBsYXRlT3B0aW9ucy4ke29wdH1gXSksXG4gICAgICApXG4gICAgICAuZm9yRWFjaCgob3B0KSA9PiB7XG4gICAgICAgIHZhbGlkYXRvcnMucHVzaCgoY29udHJvbDogRm9ybUNvbnRyb2wpID0+IHtcbiAgICAgICAgICBpZiAoZmllbGQudGVtcGxhdGVPcHRpb25zW29wdF0gPT09IGZhbHNlKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRWYWxpZGF0aW9uKG9wdCwgZmllbGQudGVtcGxhdGVPcHRpb25zW29wdF0pKGNvbnRyb2wpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgaWYgKGZpZWxkLnZhbGlkYXRvcnMpIHtcbiAgICAgIGZvciAoY29uc3QgdmFsaWRhdG9yTmFtZSBpbiBmaWVsZC52YWxpZGF0b3JzKSB7XG4gICAgICAgIGlmICh2YWxpZGF0b3JOYW1lICE9PSAndmFsaWRhdGlvbicpIHtcbiAgICAgICAgICBsZXQgdmFsaWRhdG9yID0gZmllbGQudmFsaWRhdG9yc1t2YWxpZGF0b3JOYW1lXTtcbiAgICAgICAgICBsZXQgZXJyb3JQYXRoO1xuICAgICAgICAgIGxldCBtZXNzYWdlO1xuICAgICAgICAgIGlmIChpc09iamVjdCh2YWxpZGF0b3IpKSB7XG4gICAgICAgICAgICBlcnJvclBhdGggPSB2YWxpZGF0b3IuZXJyb3JQYXRoO1xuICAgICAgICAgICAgbWVzc2FnZSA9IHZhbGlkYXRvci5tZXNzYWdlO1xuICAgICAgICAgICAgdmFsaWRhdG9yID0gdmFsaWRhdG9yLmV4cHJlc3Npb247XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdmFsaWRhdG9ycy5wdXNoKChjb250cm9sOiBGb3JtQ29udHJvbCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaXNWYWxpZCA9IHZhbGlkYXRvcihjb250cm9sLCBmaWVsZCk7XG4gICAgICAgICAgICBpZiAoZXJyb3JQYXRoICYmIGZpZWxkLmZvcm1Db250cm9sICYmIGZpZWxkLmZvcm1Db250cm9sLmdldChlcnJvclBhdGgpKSB7XG4gICAgICAgICAgICAgIGlmICghaXNWYWxpZCkge1xuICAgICAgICAgICAgICAgIGZpZWxkLmZvcm1Db250cm9sLmdldChlcnJvclBhdGgpLnNldEVycm9ycyh7XG4gICAgICAgICAgICAgICAgICAuLi4oZmllbGQuZm9ybUNvbnRyb2wuZ2V0KGVycm9yUGF0aCkuZXJyb3JzIHx8IHt9KSxcbiAgICAgICAgICAgICAgICAgIFt2YWxpZGF0b3JOYW1lXTogeyBtZXNzYWdlIH0sXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZXJyb3JzID0gKGZpZWxkLmZvcm1Db250cm9sLmdldChlcnJvclBhdGgpLmVycm9ycyB8fCB7fSk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIGVycm9yc1t2YWxpZGF0b3JOYW1lXTtcbiAgICAgICAgICAgICAgICBmaWVsZC5mb3JtQ29udHJvbC5nZXQoZXJyb3JQYXRoKS5zZXRFcnJvcnMoT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGggPT09IDAgPyBudWxsIDogZXJyb3JzKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gaXNWYWxpZCA/IG51bGwgOiB7IFt2YWxpZGF0b3JOYW1lXTogZXJyb3JQYXRoID8geyBlcnJvclBhdGggfSA6IHRydWUgfTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChmaWVsZC52YWxpZGF0b3JzICYmIEFycmF5LmlzQXJyYXkoZmllbGQudmFsaWRhdG9ycy52YWxpZGF0aW9uKSkge1xuICAgICAgZmllbGQudmFsaWRhdG9ycy52YWxpZGF0aW9uXG4gICAgICAgIC5mb3JFYWNoKCh2YWxpZGF0b3I6IGFueSkgPT4gdmFsaWRhdG9ycy5wdXNoKHRoaXMud3JhcE5nVmFsaWRhdG9yRm4oZmllbGQsIHZhbGlkYXRvcikpKTtcbiAgICB9XG5cbiAgICBpZiAodmFsaWRhdG9ycy5sZW5ndGgpIHtcbiAgICAgIGlmIChmaWVsZC52YWxpZGF0b3JzICYmICFBcnJheS5pc0FycmF5KGZpZWxkLnZhbGlkYXRvcnMudmFsaWRhdGlvbikpIHtcbiAgICAgICAgZmllbGQudmFsaWRhdG9ycy52YWxpZGF0aW9uID0gVmFsaWRhdG9ycy5jb21wb3NlKFtmaWVsZC52YWxpZGF0b3JzLnZhbGlkYXRpb24sIC4uLnZhbGlkYXRvcnNdKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZpZWxkLnZhbGlkYXRvcnMgPSB7XG4gICAgICAgICAgdmFsaWRhdGlvbjogVmFsaWRhdG9ycy5jb21wb3NlKHZhbGlkYXRvcnMpLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkRm9ybUNvbnRyb2woZm9ybTogRm9ybUdyb3VwIHwgRm9ybUFycmF5LCBmaWVsZDogRm9ybWx5RmllbGRDb25maWcsIG1vZGVsOiBhbnksIHBhdGg6IHN0cmluZykge1xuICAgIGxldCBjb250cm9sOiBBYnN0cmFjdENvbnRyb2w7XG4gICAgY29uc3QgdmFsaWRhdG9ycyA9IGZpZWxkLnZhbGlkYXRvcnMgPyBmaWVsZC52YWxpZGF0b3JzLnZhbGlkYXRpb24gOiB1bmRlZmluZWQsXG4gICAgICBhc3luY1ZhbGlkYXRvcnMgPSBmaWVsZC5hc3luY1ZhbGlkYXRvcnMgPyBmaWVsZC5hc3luY1ZhbGlkYXRvcnMudmFsaWRhdGlvbiA6IHVuZGVmaW5lZCxcbiAgICAgIHVwZGF0ZU9uID0gZmllbGQubW9kZWxPcHRpb25zICYmIGZpZWxkLm1vZGVsT3B0aW9ucy51cGRhdGVPbiA/XG4gICAgICAgIGZpZWxkLm1vZGVsT3B0aW9ucy51cGRhdGVPbiA6IHVuZGVmaW5lZDtcbiAgICBjb25zdCBhYnN0cmFjdENvbnRyb2xPcHRpb25zID0ge1xuICAgICAgdmFsaWRhdG9ycyxcbiAgICAgIGFzeW5jVmFsaWRhdG9ycyxcbiAgICAgIHVwZGF0ZU9uLFxuICAgIH0gYXMgQWJzdHJhY3RDb250cm9sT3B0aW9ucztcblxuICAgIGlmIChmaWVsZC5mb3JtQ29udHJvbCBpbnN0YW5jZW9mIEFic3RyYWN0Q29udHJvbCB8fCBmb3JtLmdldChwYXRoKSkge1xuICAgICAgY29udHJvbCA9IGZpZWxkLmZvcm1Db250cm9sIHx8IGZvcm0uZ2V0KHBhdGgpO1xuICAgICAgaWYgKFxuICAgICAgICAhKGlzTnVsbE9yVW5kZWZpbmVkKGNvbnRyb2wudmFsdWUpICYmIGlzTnVsbE9yVW5kZWZpbmVkKG1vZGVsW3BhdGhdKSlcbiAgICAgICAgJiYgY29udHJvbC52YWx1ZSAhPT0gbW9kZWxbcGF0aF1cbiAgICAgICAgJiYgY29udHJvbCBpbnN0YW5jZW9mIEZvcm1Db250cm9sXG4gICAgICApIHtcbiAgICAgICAgY29udHJvbC5wYXRjaFZhbHVlKG1vZGVsW3BhdGhdKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGZpZWxkLmNvbXBvbmVudCAmJiBmaWVsZC5jb21wb25lbnQuY3JlYXRlQ29udHJvbCkge1xuICAgICAgY29udHJvbCA9IGZpZWxkLmNvbXBvbmVudC5jcmVhdGVDb250cm9sKG1vZGVsW3BhdGhdLCBmaWVsZCk7XG4gICAgfSBlbHNlIGlmIChmaWVsZC5maWVsZEdyb3VwICYmIGZpZWxkLmtleSAmJiBmaWVsZC5rZXkgPT09IHBhdGggJiYgIWZpZWxkLmZpZWxkQXJyYXkpIHtcbiAgICAgIGNvbnRyb2wgPSBuZXcgRm9ybUdyb3VwKG1vZGVsW3BhdGhdLCBhYnN0cmFjdENvbnRyb2xPcHRpb25zKTtcbiAgICB9IGVsc2UgaWYgKGZpZWxkLmZpZWxkQXJyYXkgJiYgZmllbGQua2V5ICYmIGZpZWxkLmtleSA9PT0gcGF0aCkge1xuICAgICAgY29udHJvbCA9IG5ldyBGb3JtQXJyYXkoW10sIGFic3RyYWN0Q29udHJvbE9wdGlvbnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb250cm9sID0gbmV3IEZvcm1Db250cm9sKG1vZGVsW3BhdGhdLCBhYnN0cmFjdENvbnRyb2xPcHRpb25zKTtcbiAgICB9XG5cbiAgICBpZiAoZmllbGQudGVtcGxhdGVPcHRpb25zLmRpc2FibGVkKSB7XG4gICAgICBjb250cm9sLmRpc2FibGUoKTtcbiAgICB9XG5cbiAgICAvLyBSZXBsYWNlIGRlY29yYXRlZCBwcm9wZXJ0eSB3aXRoIGEgZ2V0dGVyIHRoYXQgcmV0dXJucyB0aGUgb2JzZXJ2YWJsZS5cbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci1yZWR1eC9zdG9yZS9ibG9iL21hc3Rlci9zcmMvZGVjb3JhdG9ycy9zZWxlY3QudHMjTDc5LUw4NVxuICAgIGlmIChkZWxldGUgZmllbGQudGVtcGxhdGVPcHRpb25zLmRpc2FibGVkKSB7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZmllbGQudGVtcGxhdGVPcHRpb25zLCAnZGlzYWJsZWQnLCB7XG4gICAgICAgIGdldDogKGZ1bmN0aW9uICgpIHsgcmV0dXJuICF0aGlzLmZvcm1Db250cm9sLmVuYWJsZWQ7IH0pLmJpbmQoZmllbGQpLFxuICAgICAgICBzZXQ6IChmdW5jdGlvbiAodmFsdWU6IGJvb2xlYW4pIHtcbiAgICAgICAgICBpZiAodGhpcy5leHByZXNzaW9uUHJvcGVydGllcyAmJiB0aGlzLmV4cHJlc3Npb25Qcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KCd0ZW1wbGF0ZU9wdGlvbnMuZGlzYWJsZWQnKSkge1xuICAgICAgICAgICAgdGhpcy5leHByZXNzaW9uUHJvcGVydGllc1sndGVtcGxhdGVPcHRpb25zLmRpc2FibGVkJ10uZXhwcmVzc2lvblZhbHVlID0gdmFsdWU7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdmFsdWUgPyB0aGlzLmZvcm1Db250cm9sLmRpc2FibGUoKSA6IHRoaXMuZm9ybUNvbnRyb2wuZW5hYmxlKCk7XG4gICAgICAgIH0pLmJpbmQoZmllbGQpLFxuICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLmFkZENvbnRyb2woZm9ybSwgcGF0aCwgY29udHJvbCwgZmllbGQpO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRDb250cm9sKGZvcm06IEZvcm1Hcm91cCB8IEZvcm1BcnJheSwga2V5OiBzdHJpbmcgfCBudW1iZXIsIGZvcm1Db250cm9sOiBBYnN0cmFjdENvbnRyb2wsIGZpZWxkPzogRm9ybWx5RmllbGRDb25maWcpIHtcbiAgICBpZiAoZmllbGQpIHtcbiAgICAgIGZpZWxkLmZvcm1Db250cm9sID0gZm9ybUNvbnRyb2w7XG4gICAgfVxuXG4gICAgaWYgKGZvcm0gaW5zdGFuY2VvZiBGb3JtQXJyYXkpIHtcbiAgICAgIGlmIChmb3JtLmF0KDxudW1iZXI+IGtleSkgIT09IGZvcm1Db250cm9sKSB7XG4gICAgICAgIGZvcm0uc2V0Q29udHJvbCg8bnVtYmVyPmtleSwgZm9ybUNvbnRyb2wpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZm9ybS5nZXQoPHN0cmluZz4ga2V5KSAhPT0gZm9ybUNvbnRyb2wpIHtcbiAgICAgICAgZm9ybS5zZXRDb250cm9sKDxzdHJpbmc+a2V5LCBmb3JtQ29udHJvbCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRWYWxpZGF0aW9uKG9wdDogc3RyaW5nLCB2YWx1ZTogYW55KSB7XG4gICAgc3dpdGNoIChvcHQpIHtcbiAgICAgIGNhc2UgJ3JlcXVpcmVkJzpcbiAgICAgICAgcmV0dXJuIFZhbGlkYXRvcnMucmVxdWlyZWQ7XG4gICAgICBjYXNlICdwYXR0ZXJuJzpcbiAgICAgICAgcmV0dXJuIFZhbGlkYXRvcnMucGF0dGVybih2YWx1ZSk7XG4gICAgICBjYXNlICdtaW5MZW5ndGgnOlxuICAgICAgICByZXR1cm4gVmFsaWRhdG9ycy5taW5MZW5ndGgodmFsdWUpO1xuICAgICAgY2FzZSAnbWF4TGVuZ3RoJzpcbiAgICAgICAgcmV0dXJuIFZhbGlkYXRvcnMubWF4TGVuZ3RoKHZhbHVlKTtcbiAgICAgIGNhc2UgJ21pbic6XG4gICAgICAgIHJldHVybiBWYWxpZGF0b3JzLm1pbih2YWx1ZSk7XG4gICAgICBjYXNlICdtYXgnOlxuICAgICAgICByZXR1cm4gVmFsaWRhdG9ycy5tYXgodmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgd3JhcE5nVmFsaWRhdG9yRm4oZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnLCB2YWxpZGF0b3I6IHN0cmluZyB8IEZpZWxkVmFsaWRhdG9yRm4pIHtcbiAgICB2YWxpZGF0b3IgPSB0eXBlb2YgdmFsaWRhdG9yID09PSAnc3RyaW5nJ1xuICAgID8gdGhpcy5mb3JtbHlDb25maWcuZ2V0VmFsaWRhdG9yKHZhbGlkYXRvcikudmFsaWRhdGlvblxuICAgIDogdmFsaWRhdG9yO1xuXG4gICAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpID0+ICh2YWxpZGF0b3IgYXMgRmllbGRWYWxpZGF0b3JGbikoY29udHJvbCwgZmllbGQpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0RmllbGRXcmFwcGVycyhmaWVsZDogRm9ybWx5RmllbGRDb25maWcpIHtcbiAgICBjb25zdCB0ZW1wbGF0ZU1hbmlwdWxhdG9yczogVGVtcGxhdGVNYW5pcHVsYXRvcnMgPSB7XG4gICAgICBwcmVXcmFwcGVyOiBbXSxcbiAgICAgIHBvc3RXcmFwcGVyOiBbXSxcbiAgICB9O1xuXG4gICAgaWYgKGZpZWxkLnRlbXBsYXRlT3B0aW9ucykge1xuICAgICAgdGhpcy5tZXJnZVRlbXBsYXRlTWFuaXB1bGF0b3JzKHRlbXBsYXRlTWFuaXB1bGF0b3JzLCBmaWVsZC50ZW1wbGF0ZU9wdGlvbnMudGVtcGxhdGVNYW5pcHVsYXRvcnMpO1xuICAgIH1cblxuICAgIHRoaXMubWVyZ2VUZW1wbGF0ZU1hbmlwdWxhdG9ycyh0ZW1wbGF0ZU1hbmlwdWxhdG9ycywgdGhpcy5mb3JtbHlDb25maWcudGVtcGxhdGVNYW5pcHVsYXRvcnMpO1xuICAgIGlmICghZmllbGQud3JhcHBlcnMpIHtcbiAgICAgIGZpZWxkLndyYXBwZXJzID0gW107XG4gICAgfVxuXG4gICAgY29uc3QgcHJlV3JhcHBlcnMgPSB0ZW1wbGF0ZU1hbmlwdWxhdG9ycy5wcmVXcmFwcGVyXG4gICAgICAubWFwKG0gPT4gbShmaWVsZCkpXG4gICAgICAuZmlsdGVyKHdyYXBwZXIgPT4gd3JhcHBlciAmJiBmaWVsZC53cmFwcGVycy5pbmRleE9mKHdyYXBwZXIpID09PSAtMSk7XG5cbiAgICBjb25zdCBwb3N0V3JhcHBlcnMgPSB0ZW1wbGF0ZU1hbmlwdWxhdG9ycy5wb3N0V3JhcHBlclxuICAgICAgLm1hcChtID0+IG0oZmllbGQpKVxuICAgICAgLmZpbHRlcih3cmFwcGVyID0+IHdyYXBwZXIgJiYgZmllbGQud3JhcHBlcnMuaW5kZXhPZih3cmFwcGVyKSA9PT0gLTEpO1xuXG4gICAgZmllbGQud3JhcHBlcnMgPSBbLi4ucHJlV3JhcHBlcnMsIC4uLmZpZWxkLndyYXBwZXJzLCAuLi5wb3N0V3JhcHBlcnNdO1xuICB9XG5cbiAgcHJpdmF0ZSBtZXJnZVRlbXBsYXRlTWFuaXB1bGF0b3JzKHNvdXJjZTogVGVtcGxhdGVNYW5pcHVsYXRvcnMsIHRhcmdldDogVGVtcGxhdGVNYW5pcHVsYXRvcnMpIHtcbiAgICB0YXJnZXQgPSB0YXJnZXQgfHwge307XG4gICAgaWYgKHRhcmdldC5wcmVXcmFwcGVyKSB7XG4gICAgICBzb3VyY2UucHJlV3JhcHBlciA9IHNvdXJjZS5wcmVXcmFwcGVyLmNvbmNhdCh0YXJnZXQucHJlV3JhcHBlcik7XG4gICAgfVxuICAgIGlmICh0YXJnZXQucG9zdFdyYXBwZXIpIHtcbiAgICAgIHNvdXJjZS5wb3N0V3JhcHBlciA9IHNvdXJjZS5wb3N0V3JhcHBlci5jb25jYXQodGFyZ2V0LnBvc3RXcmFwcGVyKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc291cmNlO1xuICB9XG59XG4iXX0=