/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { FormGroup, FormArray, FormControl, AbstractControl, Validators } from '@angular/forms';
import { FormlyConfig } from './formly.config';
import { FORMLY_VALIDATORS, evalStringExpression, evalExpressionValueSetter, getFieldId, isObject, isNullOrUndefined, clone, assignModelToFields } from './../utils';
import { getKeyPath, isFunction } from '../utils';
import { FormlyFormExpression } from './formly.form.expression';
var FormlyFormBuilder = /** @class */ (function () {
    function FormlyFormBuilder(formlyConfig, formlyFormExpression) {
        this.formlyConfig = formlyConfig;
        this.formlyFormExpression = formlyFormExpression;
        this.formId = 0;
    }
    /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} model
     * @param {?=} options
     * @return {?}
     */
    FormlyFormBuilder.prototype.buildForm = /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} model
     * @param {?=} options
     * @return {?}
     */
    function (form, fields, model, options) {
        if (fields === void 0) { fields = []; }
        var /** @type {?} */ fieldTransforms = (options && options.fieldTransform) || this.formlyConfig.extras.fieldTransform;
        if (!Array.isArray(fieldTransforms)) {
            fieldTransforms = [fieldTransforms];
        }
        fieldTransforms.forEach(function (fieldTransform) {
            if (fieldTransform) {
                fields = fieldTransform(fields, model, form, options);
                if (!fields) {
                    throw new Error('fieldTransform must return an array of fields');
                }
            }
        });
        assignModelToFields(fields, model);
        this._buildForm(form, fields, options);
        this.formlyFormExpression.checkFields(form, fields, model, options);
    };
    /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} options
     * @return {?}
     */
    FormlyFormBuilder.prototype._buildForm = /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} options
     * @return {?}
     */
    function (form, fields, options) {
        if (fields === void 0) { fields = []; }
        this.formId++;
        this.registerFormControls(form, fields, options);
    };
    /**
     * @param {?} form
     * @param {?} fields
     * @param {?} options
     * @return {?}
     */
    FormlyFormBuilder.prototype.registerFormControls = /**
     * @param {?} form
     * @param {?} fields
     * @param {?} options
     * @return {?}
     */
    function (form, fields, options) {
        var _this = this;
        fields.forEach(function (field, index) {
            field.id = getFieldId("formly_" + _this.formId, field, index);
            _this.initFieldOptions(field);
            _this.initFieldExpression(field, options);
            _this.initFieldValidation(field);
            _this.initFieldWrappers(field);
            _this.initFieldAsyncValidation(field);
            if (field.key && field.type) {
                var /** @type {?} */ paths_1 = getKeyPath({ key: field.key });
                var /** @type {?} */ rootForm_1 = form, /** @type {?} */ rootModel_1 = field.model;
                paths_1.forEach(function (path, index) {
                    // FormGroup/FormArray only allow string value for path
                    var /** @type {?} */ formPath = path.toString();
                    // is last item
                    if (index === paths_1.length - 1) {
                        _this.addFormControl(rootForm_1, field, rootModel_1, formPath);
                        if (field.fieldArray) {
                            field.fieldGroup = [];
                            field.model.forEach(function (m, i) { return field.fieldGroup.push(tslib_1.__assign({}, clone(field.fieldArray), { key: "" + i })); });
                            assignModelToFields(field.fieldGroup, rootModel_1);
                        }
                    }
                    else {
                        var /** @type {?} */ nestedForm = /** @type {?} */ (rootForm_1.get(formPath));
                        if (!nestedForm) {
                            nestedForm = new FormGroup({});
                            _this.addControl(rootForm_1, formPath, nestedForm);
                        }
                        if (!rootModel_1[path]) {
                            rootModel_1[path] = typeof path === 'string' ? {} : [];
                        }
                        rootForm_1 = nestedForm;
                        rootModel_1 = rootModel_1[path];
                    }
                });
            }
            if (field.fieldGroup) {
                if (!field.type) {
                    field.type = 'formly-group';
                }
                // if `hideExpression` is set in that case we have to deal
                // with toggle FormControl for each field in fieldGroup separately
                if (field.hideExpression) {
                    field.fieldGroup.forEach(function (f) {
                        var /** @type {?} */ hideExpression = f.hideExpression || (function () { return false; });
                        if (typeof hideExpression === 'string') {
                            hideExpression = evalStringExpression(hideExpression, ['model', 'formState']);
                        }
                        f.hideExpression = function (model, formState) { return field.hide || hideExpression(model, formState); };
                    });
                }
                if (field.key) {
                    _this.addFormControl(form, field, (_a = {}, _a[field.key] = field.fieldArray ? [] : {}, _a), field.key);
                    _this._buildForm(/** @type {?} */ (field.formControl), field.fieldGroup, options);
                }
                else {
                    _this._buildForm(form, field.fieldGroup, options);
                }
            }
            var _a;
        });
    };
    /**
     * @param {?} field
     * @param {?} options
     * @return {?}
     */
    FormlyFormBuilder.prototype.initFieldExpression = /**
     * @param {?} field
     * @param {?} options
     * @return {?}
     */
    function (field, options) {
        if (field.expressionProperties) {
            for (var /** @type {?} */ key in /** @type {?} */ (field.expressionProperties)) {
                if (typeof field.expressionProperties[key] === 'string' || isFunction(field.expressionProperties[key])) {
                    // cache built expression
                    field.expressionProperties[key] = {
                        expression: isFunction(field.expressionProperties[key]) ? field.expressionProperties[key] : evalStringExpression(field.expressionProperties[key], ['model', 'formState']),
                        expressionValueSetter: evalExpressionValueSetter("field." + key, ['expressionValue', 'model', 'field']),
                    };
                }
            }
        }
        if (field.hideExpression) {
            // delete hide value in order to force re-evaluate it in FormlyFormExpression.
            delete field.hide;
            if (typeof field.hideExpression === 'string') {
                // cache built expression
                field.hideExpression = evalStringExpression(field.hideExpression, ['model', 'formState']);
            }
        }
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FormlyFormBuilder.prototype.initFieldOptions = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        field.templateOptions = field.templateOptions || {};
        if (field.type) {
            this.formlyConfig.getMergedField(field);
            if (field.key) {
                field.templateOptions = Object.assign({
                    label: '',
                    placeholder: '',
                    focus: false,
                }, field.templateOptions);
            }
        }
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FormlyFormBuilder.prototype.initFieldAsyncValidation = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        var _this = this;
        var /** @type {?} */ validators = [];
        if (field.asyncValidators) {
            var _loop_1 = function (validatorName) {
                if (validatorName !== 'validation') {
                    var /** @type {?} */ validator_1 = field.asyncValidators[validatorName];
                    if (isObject(validator_1)) {
                        validator_1 = validator_1.expression;
                    }
                    validators.push(function (control) { return new Promise(function (resolve) {
                        return validator_1(control, field).then(function (result) {
                            resolve(result ? null : (_a = {}, _a[validatorName] = true, _a));
                            var _a;
                        });
                    }); });
                }
            };
            for (var /** @type {?} */ validatorName in field.asyncValidators) {
                _loop_1(validatorName);
            }
        }
        if (field.asyncValidators && Array.isArray(field.asyncValidators.validation)) {
            field.asyncValidators.validation
                .forEach(function (validator) { return validators.push(_this.wrapNgValidatorFn(field, validator)); });
        }
        if (validators.length) {
            if (field.asyncValidators && !Array.isArray(field.asyncValidators.validation)) {
                field.asyncValidators.validation = Validators.composeAsync(tslib_1.__spread([field.asyncValidators.validation], validators));
            }
            else {
                field.asyncValidators = {
                    validation: Validators.composeAsync(validators),
                };
            }
        }
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FormlyFormBuilder.prototype.initFieldValidation = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        var _this = this;
        var /** @type {?} */ validators = [];
        FORMLY_VALIDATORS
            .filter(function (opt) { return (field.templateOptions && field.templateOptions.hasOwnProperty(opt))
            || (field.expressionProperties && field.expressionProperties["templateOptions." + opt]); })
            .forEach(function (opt) {
            validators.push(function (control) {
                if (field.templateOptions[opt] === false) {
                    return null;
                }
                return _this.getValidation(opt, field.templateOptions[opt])(control);
            });
        });
        if (field.validators) {
            var _loop_2 = function (validatorName) {
                if (validatorName !== 'validation') {
                    var /** @type {?} */ validator_2 = field.validators[validatorName];
                    var /** @type {?} */ errorPath_1;
                    var /** @type {?} */ message_1;
                    if (isObject(validator_2)) {
                        errorPath_1 = validator_2.errorPath;
                        message_1 = validator_2.message;
                        validator_2 = validator_2.expression;
                    }
                    validators.push(function (control) {
                        var /** @type {?} */ isValid = validator_2(control, field);
                        if (errorPath_1 && field.formControl && field.formControl.get(errorPath_1)) {
                            if (!isValid) {
                                field.formControl.get(errorPath_1).setErrors(tslib_1.__assign({}, (field.formControl.get(errorPath_1).errors || {}), (_a = {}, _a[validatorName] = { message: message_1 }, _a)));
                            }
                            else {
                                var /** @type {?} */ errors = (field.formControl.get(errorPath_1).errors || {});
                                delete errors[validatorName];
                                field.formControl.get(errorPath_1).setErrors(Object.keys(errors).length === 0 ? null : errors);
                            }
                        }
                        return isValid ? null : (_b = {}, _b[validatorName] = errorPath_1 ? { errorPath: errorPath_1 } : true, _b);
                        var _a, _b;
                    });
                }
            };
            for (var /** @type {?} */ validatorName in field.validators) {
                _loop_2(validatorName);
            }
        }
        if (field.validators && Array.isArray(field.validators.validation)) {
            field.validators.validation
                .forEach(function (validator) { return validators.push(_this.wrapNgValidatorFn(field, validator)); });
        }
        if (validators.length) {
            if (field.validators && !Array.isArray(field.validators.validation)) {
                field.validators.validation = Validators.compose(tslib_1.__spread([field.validators.validation], validators));
            }
            else {
                field.validators = {
                    validation: Validators.compose(validators),
                };
            }
        }
    };
    /**
     * @param {?} form
     * @param {?} field
     * @param {?} model
     * @param {?} path
     * @return {?}
     */
    FormlyFormBuilder.prototype.addFormControl = /**
     * @param {?} form
     * @param {?} field
     * @param {?} model
     * @param {?} path
     * @return {?}
     */
    function (form, field, model, path) {
        var /** @type {?} */ control;
        var /** @type {?} */ validators = field.validators ? field.validators.validation : undefined, /** @type {?} */
        asyncValidators = field.asyncValidators ? field.asyncValidators.validation : undefined, /** @type {?} */
        updateOn = field.modelOptions && field.modelOptions.updateOn ?
            field.modelOptions.updateOn : undefined;
        var /** @type {?} */ abstractControlOptions = /** @type {?} */ ({
            validators: validators,
            asyncValidators: asyncValidators,
            updateOn: updateOn,
        });
        if (field.formControl instanceof AbstractControl || form.get(path)) {
            control = field.formControl || form.get(path);
            if (!(isNullOrUndefined(control.value) && isNullOrUndefined(model[path]))
                && control.value !== model[path]
                && control instanceof FormControl) {
                control.patchValue(model[path]);
            }
        }
        else if (field.component && field.component.createControl) {
            control = field.component.createControl(model[path], field);
        }
        else if (field.fieldGroup && field.key && field.key === path && !field.fieldArray) {
            control = new FormGroup(model[path], abstractControlOptions);
        }
        else if (field.fieldArray && field.key && field.key === path) {
            control = new FormArray([], abstractControlOptions);
        }
        else {
            control = new FormControl(model[path], abstractControlOptions);
        }
        if (field.templateOptions.disabled) {
            control.disable();
        }
        // Replace decorated property with a getter that returns the observable.
        // https://github.com/angular-redux/store/blob/master/src/decorators/select.ts#L79-L85
        if (delete field.templateOptions.disabled) {
            Object.defineProperty(field.templateOptions, 'disabled', {
                get: (function () { return !this.formControl.enabled; }).bind(field),
                set: (function (value) {
                    if (this.expressionProperties && this.expressionProperties.hasOwnProperty('templateOptions.disabled')) {
                        this.expressionProperties['templateOptions.disabled'].expressionValue = value;
                    }
                    value ? this.formControl.disable() : this.formControl.enable();
                }).bind(field),
                enumerable: true,
                configurable: true,
            });
        }
        this.addControl(form, path, control, field);
    };
    /**
     * @param {?} form
     * @param {?} key
     * @param {?} formControl
     * @param {?=} field
     * @return {?}
     */
    FormlyFormBuilder.prototype.addControl = /**
     * @param {?} form
     * @param {?} key
     * @param {?} formControl
     * @param {?=} field
     * @return {?}
     */
    function (form, key, formControl, field) {
        if (field) {
            field.formControl = formControl;
        }
        if (form instanceof FormArray) {
            if (form.at(/** @type {?} */ (key)) !== formControl) {
                form.setControl(/** @type {?} */ (key), formControl);
            }
        }
        else {
            if (form.get(/** @type {?} */ (key)) !== formControl) {
                form.setControl(/** @type {?} */ (key), formControl);
            }
        }
    };
    /**
     * @param {?} opt
     * @param {?} value
     * @return {?}
     */
    FormlyFormBuilder.prototype.getValidation = /**
     * @param {?} opt
     * @param {?} value
     * @return {?}
     */
    function (opt, value) {
        switch (opt) {
            case 'required':
                return Validators.required;
            case 'pattern':
                return Validators.pattern(value);
            case 'minLength':
                return Validators.minLength(value);
            case 'maxLength':
                return Validators.maxLength(value);
            case 'min':
                return Validators.min(value);
            case 'max':
                return Validators.max(value);
        }
    };
    /**
     * @param {?} field
     * @param {?} validator
     * @return {?}
     */
    FormlyFormBuilder.prototype.wrapNgValidatorFn = /**
     * @param {?} field
     * @param {?} validator
     * @return {?}
     */
    function (field, validator) {
        validator = typeof validator === 'string'
            ? this.formlyConfig.getValidator(validator).validation
            : validator;
        return function (control) { return (/** @type {?} */ (validator))(control, field); };
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FormlyFormBuilder.prototype.initFieldWrappers = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        var /** @type {?} */ templateManipulators = {
            preWrapper: [],
            postWrapper: [],
        };
        if (field.templateOptions) {
            this.mergeTemplateManipulators(templateManipulators, field.templateOptions.templateManipulators);
        }
        this.mergeTemplateManipulators(templateManipulators, this.formlyConfig.templateManipulators);
        if (!field.wrappers) {
            field.wrappers = [];
        }
        var /** @type {?} */ preWrappers = templateManipulators.preWrapper
            .map(function (m) { return m(field); })
            .filter(function (wrapper) { return wrapper && field.wrappers.indexOf(wrapper) === -1; });
        var /** @type {?} */ postWrappers = templateManipulators.postWrapper
            .map(function (m) { return m(field); })
            .filter(function (wrapper) { return wrapper && field.wrappers.indexOf(wrapper) === -1; });
        field.wrappers = tslib_1.__spread(preWrappers, field.wrappers, postWrappers);
    };
    /**
     * @param {?} source
     * @param {?} target
     * @return {?}
     */
    FormlyFormBuilder.prototype.mergeTemplateManipulators = /**
     * @param {?} source
     * @param {?} target
     * @return {?}
     */
    function (source, target) {
        target = target || {};
        if (target.preWrapper) {
            source.preWrapper = source.preWrapper.concat(target.preWrapper);
        }
        if (target.postWrapper) {
            source.postWrapper = source.postWrapper.concat(target.postWrapper);
        }
        return source;
    };
    FormlyFormBuilder.decorators = [
        { type: Injectable },
    ];
    /** @nocollapse */
    FormlyFormBuilder.ctorParameters = function () { return [
        { type: FormlyConfig },
        { type: FormlyFormExpression }
    ]; };
    return FormlyFormBuilder;
}());
export { FormlyFormBuilder };
function FormlyFormBuilder_tsickle_Closure_declarations() {
    /** @type {?} */
    FormlyFormBuilder.prototype.formId;
    /** @type {?} */
    FormlyFormBuilder.prototype.formlyConfig;
    /** @type {?} */
    FormlyFormBuilder.prototype.formlyFormExpression;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWx5LmZvcm0uYnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3gtZm9ybWx5L2NvcmUvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvZm9ybWx5LmZvcm0uYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQTBCLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEgsT0FBTyxFQUFFLFlBQVksRUFBMEMsTUFBTSxpQkFBaUIsQ0FBQztBQUN2RixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsb0JBQW9CLEVBQUUseUJBQXlCLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxpQkFBaUIsRUFBRSxLQUFLLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFFckssT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7O0lBTTlELDJCQUNVLGNBQ0E7UUFEQSxpQkFBWSxHQUFaLFlBQVk7UUFDWix5QkFBb0IsR0FBcEIsb0JBQW9CO3NCQUpiLENBQUM7S0FLZDs7Ozs7Ozs7SUFFSixxQ0FBUzs7Ozs7OztJQUFULFVBQVUsSUFBMkIsRUFBRSxNQUFnQyxFQUFFLEtBQVUsRUFBRSxPQUEwQjtRQUF4RSx1QkFBQSxFQUFBLFdBQWdDO1FBQ3JFLHFCQUFJLGVBQWUsR0FBRyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDO1FBQ3JHLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEMs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Q0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQ2pFO1FBQ0QsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFDdkIsTUFBTSxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDcEU7UUFFRCxNQUFNLENBQUMsTUFBTSxDQUFDOzs7Z0JBdlhqQixVQUFVOzs7O2dCQU5GLFlBQVk7Z0JBSVosb0JBQW9COzs0QkFON0I7O1NBU2EsaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybUdyb3VwLCBGb3JtQXJyYXksIEZvcm1Db250cm9sLCBBYnN0cmFjdENvbnRyb2wsIFZhbGlkYXRvcnMsIEFic3RyYWN0Q29udHJvbE9wdGlvbnMgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBGb3JtbHlDb25maWcsIEZpZWxkVmFsaWRhdG9yRm4sIFRlbXBsYXRlTWFuaXB1bGF0b3JzIH0gZnJvbSAnLi9mb3JtbHkuY29uZmlnJztcbmltcG9ydCB7IEZPUk1MWV9WQUxJREFUT1JTLCBldmFsU3RyaW5nRXhwcmVzc2lvbiwgZXZhbEV4cHJlc3Npb25WYWx1ZVNldHRlciwgZ2V0RmllbGRJZCwgaXNPYmplY3QsIGlzTnVsbE9yVW5kZWZpbmVkLCBjbG9uZSwgYXNzaWduTW9kZWxUb0ZpZWxkcyB9IGZyb20gJy4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgRm9ybWx5RmllbGRDb25maWcsIEZvcm1seUZvcm1PcHRpb25zIH0gZnJvbSAnLi4vY29tcG9uZW50cy9mb3JtbHkuZmllbGQuY29uZmlnJztcbmltcG9ydCB7IGdldEtleVBhdGgsIGlzRnVuY3Rpb24gfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyBGb3JtbHlGb3JtRXhwcmVzc2lvbiB9IGZyb20gJy4vZm9ybWx5LmZvcm0uZXhwcmVzc2lvbic7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBGb3JtbHlGb3JtQnVpbGRlciB7XG4gIHByaXZhdGUgZm9ybUlkID0gMDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGZvcm1seUNvbmZpZzogRm9ybWx5Q29uZmlnLFxuICAgIHByaXZhdGUgZm9ybWx5Rm9ybUV4cHJlc3Npb246IEZvcm1seUZvcm1FeHByZXNzaW9uLFxuICApIHt9XG5cbiAgYnVpbGRGb3JtKGZvcm06IEZvcm1Hcm91cCB8IEZvcm1BcnJheSwgZmllbGRzOiBGb3JtbHlGaWVsZENvbmZpZ1tdID0gW10sIG1vZGVsOiBhbnksIG9wdGlvbnM6IEZvcm1seUZvcm1PcHRpb25zKSB7XG4gICAgbGV0IGZpZWxkVHJhbnNmb3JtcyA9IChvcHRpb25zICYmIG9wdGlvbnMuZmllbGRUcmFuc2Zvcm0pIHx8IHRoaXMuZm9ybWx5Q29uZmlnLmV4dHJhcy5maWVsZFRyYW5zZm9ybTtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZmllbGRUcmFuc2Zvcm1zKSkge1xuICAgICAgZmllbGRUcmFuc2Zvcm1zID0gW2ZpZWxkVHJhbnNmb3Jtc107XG4gICAgfVxuXG4gICAgZmllbGRUcmFuc2Zvcm1zLmZvckVhY2goZmllbGRUcmFuc2Zvcm0gPT4ge1xuICAgICAgaWYgKGZpZWxkVHJhbnNmb3JtKSB7XG4gICAgICAgIGZpZWxkcyA9IGZpZWxkVHJhbnNmb3JtKGZpZWxkcywgbW9kZWwsIGZvcm0sIG9wdGlvbnMpO1xuICAgICAgICBpZiAoIWZpZWxkcykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignZmllbGRUcmFuc2Zvcm0gbXVzdCByZXR1cm4gYW4gYXJyYXkgb2YgZmllbGRzJyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGFzc2lnbk1vZGVsVG9GaWVsZHMoZmllbGRzLCBtb2RlbCk7XG4gICAgdGhpcy5fYnVpbGRGb3JtKGZvcm0sIGZpZWxkcywgb3B0aW9ucyk7XG4gICAgdGhpcy5mb3JtbHlGb3JtRXhwcmVzc2lvbi5jaGVja0ZpZWxkcyhmb3JtLCBmaWVsZHMsIG1vZGVsLCBvcHRpb25zKTtcbiAgfVxuXG4gIHByaXZhdGUgX2J1aWxkRm9ybShmb3JtOiBGb3JtR3JvdXAgfCBGb3JtQXJyYXksIGZpZWxkczogRm9ybWx5RmllbGRDb25maWdbXSA9IFtdLCBvcHRpb25zOiBGb3JtbHlGb3JtT3B0aW9ucykge1xuICAgIHRoaXMuZm9ybUlkKys7XG4gICAgdGhpcy5yZWdpc3RlckZvcm1Db250cm9scyhmb3JtLCBmaWVsZHMsIG9wdGlvbnMpO1xuICB9XG5cbiAgcHJpdmF0ZSByZWdpc3RlckZvcm1Db250cm9scyhmb3JtOiBGb3JtR3JvdXAgfCBGb3JtQXJyYXksIGZpZWxkczogRm9ybWx5RmllbGRDb25maWdbXSwgb3B0aW9uczogRm9ybWx5Rm9ybU9wdGlvbnMpIHtcbiAgICBmaWVsZHMuZm9yRWFjaCgoZmllbGQsIGluZGV4KSA9PiB7XG4gICAgICBmaWVsZC5pZCA9IGdldEZpZWxkSWQoYGZvcm1seV8ke3RoaXMuZm9ybUlkfWAsIGZpZWxkLCBpbmRleCk7XG4gICAgICB0aGlzLmluaXRGaWVsZE9wdGlvbnMoZmllbGQpO1xuICAgICAgdGhpcy5pbml0RmllbGRFeHByZXNzaW9uKGZpZWxkLCBvcHRpb25zKTtcbiAgICAgIHRoaXMuaW5pdEZpZWxkVmFsaWRhdGlvbihmaWVsZCk7XG4gICAgICB0aGlzLmluaXRGaWVsZFdyYXBwZXJzKGZpZWxkKTtcbiAgICAgIHRoaXMuaW5pdEZpZWxkQXN5bmNWYWxpZGF0aW9uKGZpZWxkKTtcblxuICAgICAgaWYgKGZpZWxkLmtleSAmJiBmaWVsZC50eXBlKSB7XG4gICAgICAgIGNvbnN0IHBhdGhzID0gZ2V0S2V5UGF0aCh7IGtleTogZmllbGQua2V5IH0pO1xuICAgICAgICBsZXQgcm9vdEZvcm0gPSBmb3JtLCByb290TW9kZWwgPSBmaWVsZC5tb2RlbDtcbiAgICAgICAgcGF0aHMuZm9yRWFjaCgocGF0aCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAvLyBGb3JtR3JvdXAvRm9ybUFycmF5IG9ubHkgYWxsb3cgc3RyaW5nIHZhbHVlIGZvciBwYXRoXG4gICAgICAgICAgY29uc3QgZm9ybVBhdGggPSBwYXRoLnRvU3RyaW5nKCk7XG4gICAgICAgICAgLy8gaXMgbGFzdCBpdGVtXG4gICAgICAgICAgaWYgKGluZGV4ID09PSBwYXRocy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICB0aGlzLmFkZEZvcm1Db250cm9sKHJvb3RGb3JtLCBmaWVsZCwgcm9vdE1vZGVsLCBmb3JtUGF0aCk7XG4gICAgICAgICAgICBpZiAoZmllbGQuZmllbGRBcnJheSkge1xuICAgICAgICAgICAgICBmaWVsZC5maWVsZEdyb3VwID0gW107XG4gICAgICAgICAgICAgIGZpZWxkLm1vZGVsLmZvckVhY2goKG06IGFueSwgaTogbnVtYmVyKSA9PiBmaWVsZC5maWVsZEdyb3VwLnB1c2goXG4gICAgICAgICAgICAgICAgeyAuLi5jbG9uZShmaWVsZC5maWVsZEFycmF5KSwga2V5OiBgJHtpfWAgfSxcbiAgICAgICAgICAgICAgKSk7XG4gICAgICAgICAgICAgIGFzc2lnbk1vZGVsVG9GaWVsZHMoZmllbGQuZmllbGRHcm91cCwgcm9vdE1vZGVsKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgbmVzdGVkRm9ybSA9IHJvb3RGb3JtLmdldChmb3JtUGF0aCkgYXMgRm9ybUdyb3VwO1xuICAgICAgICAgICAgaWYgKCFuZXN0ZWRGb3JtKSB7XG4gICAgICAgICAgICAgIG5lc3RlZEZvcm0gPSBuZXcgRm9ybUdyb3VwKHt9KTtcbiAgICAgICAgICAgICAgdGhpcy5hZGRDb250cm9sKHJvb3RGb3JtLCBmb3JtUGF0aCwgbmVzdGVkRm9ybSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXJvb3RNb2RlbFtwYXRoXSkge1xuICAgICAgICAgICAgICByb290TW9kZWxbcGF0aF0gPSB0eXBlb2YgcGF0aCA9PT0gJ3N0cmluZycgPyB7fSA6IFtdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByb290Rm9ybSA9IG5lc3RlZEZvcm07XG4gICAgICAgICAgICByb290TW9kZWwgPSByb290TW9kZWxbcGF0aF07XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKGZpZWxkLmZpZWxkR3JvdXApIHtcbiAgICAgICAgaWYgKCFmaWVsZC50eXBlKSB7XG4gICAgICAgICAgZmllbGQudHlwZSA9ICdmb3JtbHktZ3JvdXAnO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gaWYgYGhpZGVFeHByZXNzaW9uYCBpcyBzZXQgaW4gdGhhdCBjYXNlIHdlIGhhdmUgdG8gZGVhbFxuICAgICAgICAvLyB3aXRoIHRvZ2dsZSBGb3JtQ29udHJvbCBmb3IgZWFjaCBmaWVsZCBpbiBmaWVsZEdyb3VwIHNlcGFyYXRlbHlcbiAgICAgICAgaWYgKGZpZWxkLmhpZGVFeHByZXNzaW9uKSB7XG4gICAgICAgICAgZmllbGQuZmllbGRHcm91cC5mb3JFYWNoKGYgPT4ge1xuICAgICAgICAgICAgbGV0IGhpZGVFeHByZXNzaW9uOiBhbnkgPSBmLmhpZGVFeHByZXNzaW9uIHx8ICgoKSA9PiBmYWxzZSk7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGhpZGVFeHByZXNzaW9uID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICBoaWRlRXhwcmVzc2lvbiA9IGV2YWxTdHJpbmdFeHByZXNzaW9uKGhpZGVFeHByZXNzaW9uLCBbJ21vZGVsJywgJ2Zvcm1TdGF0ZSddKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZi5oaWRlRXhwcmVzc2lvbiA9IChtb2RlbCwgZm9ybVN0YXRlKSA9PiBmaWVsZC5oaWRlIHx8IGhpZGVFeHByZXNzaW9uKG1vZGVsLCBmb3JtU3RhdGUpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZpZWxkLmtleSkge1xuICAgICAgICAgIHRoaXMuYWRkRm9ybUNvbnRyb2woZm9ybSwgZmllbGQsIHsgW2ZpZWxkLmtleV06IGZpZWxkLmZpZWxkQXJyYXkgPyBbXSA6IHt9IH0sIGZpZWxkLmtleSk7XG4gICAgICAgICAgdGhpcy5fYnVpbGRGb3JtKGZpZWxkLmZvcm1Db250cm9sIGFzIEZvcm1Hcm91cCwgZmllbGQuZmllbGRHcm91cCwgb3B0aW9ucyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5fYnVpbGRGb3JtKGZvcm0sIGZpZWxkLmZpZWxkR3JvdXAsIG9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGluaXRGaWVsZEV4cHJlc3Npb24oZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnLCBvcHRpb25zOiBGb3JtbHlGb3JtT3B0aW9ucykge1xuICAgIGlmIChmaWVsZC5leHByZXNzaW9uUHJvcGVydGllcykge1xuICAgICAgZm9yIChjb25zdCBrZXkgaW4gZmllbGQuZXhwcmVzc2lvblByb3BlcnRpZXMgYXMgYW55KSB7XG4gICAgICAgIGlmICh0eXBlb2YgZmllbGQuZXhwcmVzc2lvblByb3BlcnRpZXNba2V5XSA9PT0gJ3N0cmluZycgfHwgaXNGdW5jdGlvbihmaWVsZC5leHByZXNzaW9uUHJvcGVydGllc1trZXldKSkge1xuICAgICAgICAgIC8vIGNhY2hlIGJ1aWx0IGV4cHJlc3Npb25cbiAgICAgICAgICBmaWVsZC5leHByZXNzaW9uUHJvcGVydGllc1trZXldID0ge1xuICAgICAgICAgICAgZXhwcmVzc2lvbjogaXNGdW5jdGlvbihmaWVsZC5leHByZXNzaW9uUHJvcGVydGllc1trZXldKSA/IGZpZWxkLmV4cHJlc3Npb25Qcm9wZXJ0aWVzW2tleV0gOiBldmFsU3RyaW5nRXhwcmVzc2lvbihmaWVsZC5leHByZXNzaW9uUHJvcGVydGllc1trZXldLCBbJ21vZGVsJywgJ2Zvcm1TdGF0ZSddKSxcbiAgICAgICAgICAgIGV4cHJlc3Npb25WYWx1ZVNldHRlcjogZXZhbEV4cHJlc3Npb25WYWx1ZVNldHRlcihcbiAgICAgICAgICAgICAgYGZpZWxkLiR7a2V5fWAsXG4gICAgICAgICAgICAgIFsnZXhwcmVzc2lvblZhbHVlJywgJ21vZGVsJywgJ2ZpZWxkJ10sXG4gICAgICAgICAgICApLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoZmllbGQuaGlkZUV4cHJlc3Npb24pIHtcbiAgICAgIC8vIGRlbGV0ZSBoaWRlIHZhbHVlIGluIG9yZGVyIHRvIGZvcmNlIHJlLWV2YWx1YXRlIGl0IGluIEZvcm1seUZvcm1FeHByZXNzaW9uLlxuICAgICAgZGVsZXRlIGZpZWxkLmhpZGU7XG4gICAgICBpZiAodHlwZW9mIGZpZWxkLmhpZGVFeHByZXNzaW9uID09PSAnc3RyaW5nJykge1xuICAgICAgICAvLyBjYWNoZSBidWlsdCBleHByZXNzaW9uXG4gICAgICAgIGZpZWxkLmhpZGVFeHByZXNzaW9uID0gZXZhbFN0cmluZ0V4cHJlc3Npb24oZmllbGQuaGlkZUV4cHJlc3Npb24sIFsnbW9kZWwnLCAnZm9ybVN0YXRlJ10pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaW5pdEZpZWxkT3B0aW9ucyhmaWVsZDogRm9ybWx5RmllbGRDb25maWcpIHtcbiAgICBmaWVsZC50ZW1wbGF0ZU9wdGlvbnMgPSBmaWVsZC50ZW1wbGF0ZU9wdGlvbnMgfHwge307XG4gICAgaWYgKGZpZWxkLnR5cGUpIHtcbiAgICAgIHRoaXMuZm9ybWx5Q29uZmlnLmdldE1lcmdlZEZpZWxkKGZpZWxkKTtcbiAgICAgIGlmIChmaWVsZC5rZXkpIHtcbiAgICAgICAgZmllbGQudGVtcGxhdGVPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7XG4gICAgICAgICAgbGFiZWw6ICcnLFxuICAgICAgICAgIHBsYWNlaG9sZGVyOiAnJyxcbiAgICAgICAgICBmb2N1czogZmFsc2UsXG4gICAgICAgIH0sIGZpZWxkLnRlbXBsYXRlT3B0aW9ucyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0RmllbGRBc3luY1ZhbGlkYXRpb24oZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnKSB7XG4gICAgY29uc3QgdmFsaWRhdG9yczogYW55ID0gW107XG4gICAgaWYgKGZpZWxkLmFzeW5jVmFsaWRhdG9ycykge1xuICAgICAgZm9yIChjb25zdCB2YWxpZGF0b3JOYW1lIGluIGZpZWxkLmFzeW5jVmFsaWRhdG9ycykge1xuICAgICAgICBpZiAodmFsaWRhdG9yTmFtZSAhPT0gJ3ZhbGlkYXRpb24nKSB7XG4gICAgICAgICAgbGV0IHZhbGlkYXRvciA9IGZpZWxkLmFzeW5jVmFsaWRhdG9yc1t2YWxpZGF0b3JOYW1lXTtcbiAgICAgICAgICBpZiAoaXNPYmplY3QodmFsaWRhdG9yKSkge1xuICAgICAgICAgICAgdmFsaWRhdG9yID0gdmFsaWRhdG9yLmV4cHJlc3Npb247XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdmFsaWRhdG9ycy5wdXNoKChjb250cm9sOiBGb3JtQ29udHJvbCkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB2YWxpZGF0b3IoY29udHJvbCwgZmllbGQpLnRoZW4oKHJlc3VsdDogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCA/IG51bGwgOiB7IFt2YWxpZGF0b3JOYW1lXTogdHJ1ZSB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChmaWVsZC5hc3luY1ZhbGlkYXRvcnMgJiYgQXJyYXkuaXNBcnJheShmaWVsZC5hc3luY1ZhbGlkYXRvcnMudmFsaWRhdGlvbikpIHtcbiAgICAgIGZpZWxkLmFzeW5jVmFsaWRhdG9ycy52YWxpZGF0aW9uXG4gICAgICAgIC5mb3JFYWNoKCh2YWxpZGF0b3I6IGFueSkgPT4gdmFsaWRhdG9ycy5wdXNoKHRoaXMud3JhcE5nVmFsaWRhdG9yRm4oZmllbGQsIHZhbGlkYXRvcikpKTtcbiAgICB9XG5cbiAgICBpZiAodmFsaWRhdG9ycy5sZW5ndGgpIHtcbiAgICAgIGlmIChmaWVsZC5hc3luY1ZhbGlkYXRvcnMgJiYgIUFycmF5LmlzQXJyYXkoZmllbGQuYXN5bmNWYWxpZGF0b3JzLnZhbGlkYXRpb24pKSB7XG4gICAgICAgIGZpZWxkLmFzeW5jVmFsaWRhdG9ycy52YWxpZGF0aW9uID0gVmFsaWRhdG9ycy5jb21wb3NlQXN5bmMoW2ZpZWxkLmFzeW5jVmFsaWRhdG9ycy52YWxpZGF0aW9uLCAuLi52YWxpZGF0b3JzXSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmaWVsZC5hc3luY1ZhbGlkYXRvcnMgPSB7XG4gICAgICAgICAgdmFsaWRhdGlvbjogVmFsaWRhdG9ycy5jb21wb3NlQXN5bmModmFsaWRhdG9ycyksXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0RmllbGRWYWxpZGF0aW9uKGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZykge1xuICAgIGNvbnN0IHZhbGlkYXRvcnM6IGFueSA9IFtdO1xuICAgIEZPUk1MWV9WQUxJREFUT1JTXG4gICAgICAuZmlsdGVyKG9wdCA9PiAoZmllbGQudGVtcGxhdGVPcHRpb25zICYmIGZpZWxkLnRlbXBsYXRlT3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShvcHQpKVxuICAgICAgICB8fCAoZmllbGQuZXhwcmVzc2lvblByb3BlcnRpZXMgJiYgZmllbGQuZXhwcmVzc2lvblByb3BlcnRpZXNbYHRlbXBsYXRlT3B0aW9ucy4ke29wdH1gXSksXG4gICAgICApXG4gICAgICAuZm9yRWFjaCgob3B0KSA9PiB7XG4gICAgICAgIHZhbGlkYXRvcnMucHVzaCgoY29udHJvbDogRm9ybUNvbnRyb2wpID0+IHtcbiAgICAgICAgICBpZiAoZmllbGQudGVtcGxhdGVPcHRpb25zW29wdF0gPT09IGZhbHNlKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRWYWxpZGF0aW9uKG9wdCwgZmllbGQudGVtcGxhdGVPcHRpb25zW29wdF0pKGNvbnRyb2wpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgaWYgKGZpZWxkLnZhbGlkYXRvcnMpIHtcbiAgICAgIGZvciAoY29uc3QgdmFsaWRhdG9yTmFtZSBpbiBmaWVsZC52YWxpZGF0b3JzKSB7XG4gICAgICAgIGlmICh2YWxpZGF0b3JOYW1lICE9PSAndmFsaWRhdGlvbicpIHtcbiAgICAgICAgICBsZXQgdmFsaWRhdG9yID0gZmllbGQudmFsaWRhdG9yc1t2YWxpZGF0b3JOYW1lXTtcbiAgICAgICAgICBsZXQgZXJyb3JQYXRoO1xuICAgICAgICAgIGxldCBtZXNzYWdlO1xuICAgICAgICAgIGlmIChpc09iamVjdCh2YWxpZGF0b3IpKSB7XG4gICAgICAgICAgICBlcnJvclBhdGggPSB2YWxpZGF0b3IuZXJyb3JQYXRoO1xuICAgICAgICAgICAgbWVzc2FnZSA9IHZhbGlkYXRvci5tZXNzYWdlO1xuICAgICAgICAgICAgdmFsaWRhdG9yID0gdmFsaWRhdG9yLmV4cHJlc3Npb247XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdmFsaWRhdG9ycy5wdXNoKChjb250cm9sOiBGb3JtQ29udHJvbCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaXNWYWxpZCA9IHZhbGlkYXRvcihjb250cm9sLCBmaWVsZCk7XG4gICAgICAgICAgICBpZiAoZXJyb3JQYXRoICYmIGZpZWxkLmZvcm1Db250cm9sICYmIGZpZWxkLmZvcm1Db250cm9sLmdldChlcnJvclBhdGgpKSB7XG4gICAgICAgICAgICAgIGlmICghaXNWYWxpZCkge1xuICAgICAgICAgICAgICAgIGZpZWxkLmZvcm1Db250cm9sLmdldChlcnJvclBhdGgpLnNldEVycm9ycyh7XG4gICAgICAgICAgICAgICAgICAuLi4oZmllbGQuZm9ybUNvbnRyb2wuZ2V0KGVycm9yUGF0aCkuZXJyb3JzIHx8IHt9KSxcbiAgICAgICAgICAgICAgICAgIFt2YWxpZGF0b3JOYW1lXTogeyBtZXNzYWdlIH0sXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZXJyb3JzID0gKGZpZWxkLmZvcm1Db250cm9sLmdldChlcnJvclBhdGgpLmVycm9ycyB8fCB7fSk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIGVycm9yc1t2YWxpZGF0b3JOYW1lXTtcbiAgICAgICAgICAgICAgICBmaWVsZC5mb3JtQ29udHJvbC5nZXQoZXJyb3JQYXRoKS5zZXRFcnJvcnMoT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGggPT09IDAgPyBudWxsIDogZXJyb3JzKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gaXNWYWxpZCA/IG51bGwgOiB7IFt2YWxpZGF0b3JOYW1lXTogZXJyb3JQYXRoID8geyBlcnJvclBhdGggfSA6IHRydWUgfTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChmaWVsZC52YWxpZGF0b3JzICYmIEFycmF5LmlzQXJyYXkoZmllbGQudmFsaWRhdG9ycy52YWxpZGF0aW9uKSkge1xuICAgICAgZmllbGQudmFsaWRhdG9ycy52YWxpZGF0aW9uXG4gICAgICAgIC5mb3JFYWNoKCh2YWxpZGF0b3I6IGFueSkgPT4gdmFsaWRhdG9ycy5wdXNoKHRoaXMud3JhcE5nVmFsaWRhdG9yRm4oZmllbGQsIHZhbGlkYXRvcikpKTtcbiAgICB9XG5cbiAgICBpZiAodmFsaWRhdG9ycy5sZW5ndGgpIHtcbiAgICAgIGlmIChmaWVsZC52YWxpZGF0b3JzICYmICFBcnJheS5pc0FycmF5KGZpZWxkLnZhbGlkYXRvcnMudmFsaWRhdGlvbikpIHtcbiAgICAgICAgZmllbGQudmFsaWRhdG9ycy52YWxpZGF0aW9uID0gVmFsaWRhdG9ycy5jb21wb3NlKFtmaWVsZC52YWxpZGF0b3JzLnZhbGlkYXRpb24sIC4uLnZhbGlkYXRvcnNdKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZpZWxkLnZhbGlkYXRvcnMgPSB7XG4gICAgICAgICAgdmFsaWRhdGlvbjogVmFsaWRhdG9ycy5jb21wb3NlKHZhbGlkYXRvcnMpLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkRm9ybUNvbnRyb2woZm9ybTogRm9ybUdyb3VwIHwgRm9ybUFycmF5LCBmaWVsZDogRm9ybWx5RmllbGRDb25maWcsIG1vZGVsOiBhbnksIHBhdGg6IHN0cmluZykge1xuICAgIGxldCBjb250cm9sOiBBYnN0cmFjdENvbnRyb2w7XG4gICAgY29uc3QgdmFsaWRhdG9ycyA9IGZpZWxkLnZhbGlkYXRvcnMgPyBmaWVsZC52YWxpZGF0b3JzLnZhbGlkYXRpb24gOiB1bmRlZmluZWQsXG4gICAgICBhc3luY1ZhbGlkYXRvcnMgPSBmaWVsZC5hc3luY1ZhbGlkYXRvcnMgPyBmaWVsZC5hc3luY1ZhbGlkYXRvcnMudmFsaWRhdGlvbiA6IHVuZGVmaW5lZCxcbiAgICAgIHVwZGF0ZU9uID0gZmllbGQubW9kZWxPcHRpb25zICYmIGZpZWxkLm1vZGVsT3B0aW9ucy51cGRhdGVPbiA/XG4gICAgICAgIGZpZWxkLm1vZGVsT3B0aW9ucy51cGRhdGVPbiA6IHVuZGVmaW5lZDtcbiAgICBjb25zdCBhYnN0cmFjdENvbnRyb2xPcHRpb25zID0ge1xuICAgICAgdmFsaWRhdG9ycyxcbiAgICAgIGFzeW5jVmFsaWRhdG9ycyxcbiAgICAgIHVwZGF0ZU9uLFxuICAgIH0gYXMgQWJzdHJhY3RDb250cm9sT3B0aW9ucztcblxuICAgIGlmIChmaWVsZC5mb3JtQ29udHJvbCBpbnN0YW5jZW9mIEFic3RyYWN0Q29udHJvbCB8fCBmb3JtLmdldChwYXRoKSkge1xuICAgICAgY29udHJvbCA9IGZpZWxkLmZvcm1Db250cm9sIHx8IGZvcm0uZ2V0KHBhdGgpO1xuICAgICAgaWYgKFxuICAgICAgICAhKGlzTnVsbE9yVW5kZWZpbmVkKGNvbnRyb2wudmFsdWUpICYmIGlzTnVsbE9yVW5kZWZpbmVkKG1vZGVsW3BhdGhdKSlcbiAgICAgICAgJiYgY29udHJvbC52YWx1ZSAhPT0gbW9kZWxbcGF0aF1cbiAgICAgICAgJiYgY29udHJvbCBpbnN0YW5jZW9mIEZvcm1Db250cm9sXG4gICAgICApIHtcbiAgICAgICAgY29udHJvbC5wYXRjaFZhbHVlKG1vZGVsW3BhdGhdKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGZpZWxkLmNvbXBvbmVudCAmJiBmaWVsZC5jb21wb25lbnQuY3JlYXRlQ29udHJvbCkge1xuICAgICAgY29udHJvbCA9IGZpZWxkLmNvbXBvbmVudC5jcmVhdGVDb250cm9sKG1vZGVsW3BhdGhdLCBmaWVsZCk7XG4gICAgfSBlbHNlIGlmIChmaWVsZC5maWVsZEdyb3VwICYmIGZpZWxkLmtleSAmJiBmaWVsZC5rZXkgPT09IHBhdGggJiYgIWZpZWxkLmZpZWxkQXJyYXkpIHtcbiAgICAgIGNvbnRyb2wgPSBuZXcgRm9ybUdyb3VwKG1vZGVsW3BhdGhdLCBhYnN0cmFjdENvbnRyb2xPcHRpb25zKTtcbiAgICB9IGVsc2UgaWYgKGZpZWxkLmZpZWxkQXJyYXkgJiYgZmllbGQua2V5ICYmIGZpZWxkLmtleSA9PT0gcGF0aCkge1xuICAgICAgY29udHJvbCA9IG5ldyBGb3JtQXJyYXkoW10sIGFic3RyYWN0Q29udHJvbE9wdGlvbnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb250cm9sID0gbmV3IEZvcm1Db250cm9sKG1vZGVsW3BhdGhdLCBhYnN0cmFjdENvbnRyb2xPcHRpb25zKTtcbiAgICB9XG5cbiAgICBpZiAoZmllbGQudGVtcGxhdGVPcHRpb25zLmRpc2FibGVkKSB7XG4gICAgICBjb250cm9sLmRpc2FibGUoKTtcbiAgICB9XG5cbiAgICAvLyBSZXBsYWNlIGRlY29yYXRlZCBwcm9wZXJ0eSB3aXRoIGEgZ2V0dGVyIHRoYXQgcmV0dXJucyB0aGUgb2JzZXJ2YWJsZS5cbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci1yZWR1eC9zdG9yZS9ibG9iL21hc3Rlci9zcmMvZGVjb3JhdG9ycy9zZWxlY3QudHMjTDc5LUw4NVxuICAgIGlmIChkZWxldGUgZmllbGQudGVtcGxhdGVPcHRpb25zLmRpc2FibGVkKSB7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZmllbGQudGVtcGxhdGVPcHRpb25zLCAnZGlzYWJsZWQnLCB7XG4gICAgICAgIGdldDogKGZ1bmN0aW9uICgpIHsgcmV0dXJuICF0aGlzLmZvcm1Db250cm9sLmVuYWJsZWQ7IH0pLmJpbmQoZmllbGQpLFxuICAgICAgICBzZXQ6IChmdW5jdGlvbiAodmFsdWU6IGJvb2xlYW4pIHtcbiAgICAgICAgICBpZiAodGhpcy5leHByZXNzaW9uUHJvcGVydGllcyAmJiB0aGlzLmV4cHJlc3Npb25Qcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KCd0ZW1wbGF0ZU9wdGlvbnMuZGlzYWJsZWQnKSkge1xuICAgICAgICAgICAgdGhpcy5leHByZXNzaW9uUHJvcGVydGllc1sndGVtcGxhdGVPcHRpb25zLmRpc2FibGVkJ10uZXhwcmVzc2lvblZhbHVlID0gdmFsdWU7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdmFsdWUgPyB0aGlzLmZvcm1Db250cm9sLmRpc2FibGUoKSA6IHRoaXMuZm9ybUNvbnRyb2wuZW5hYmxlKCk7XG4gICAgICAgIH0pLmJpbmQoZmllbGQpLFxuICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLmFkZENvbnRyb2woZm9ybSwgcGF0aCwgY29udHJvbCwgZmllbGQpO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRDb250cm9sKGZvcm06IEZvcm1Hcm91cCB8IEZvcm1BcnJheSwga2V5OiBzdHJpbmcgfCBudW1iZXIsIGZvcm1Db250cm9sOiBBYnN0cmFjdENvbnRyb2wsIGZpZWxkPzogRm9ybWx5RmllbGRDb25maWcpIHtcbiAgICBpZiAoZmllbGQpIHtcbiAgICAgIGZpZWxkLmZvcm1Db250cm9sID0gZm9ybUNvbnRyb2w7XG4gICAgfVxuXG4gICAgaWYgKGZvcm0gaW5zdGFuY2VvZiBGb3JtQXJyYXkpIHtcbiAgICAgIGlmIChmb3JtLmF0KDxudW1iZXI+IGtleSkgIT09IGZvcm1Db250cm9sKSB7XG4gICAgICAgIGZvcm0uc2V0Q29udHJvbCg8bnVtYmVyPmtleSwgZm9ybUNvbnRyb2wpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZm9ybS5nZXQoPHN0cmluZz4ga2V5KSAhPT0gZm9ybUNvbnRyb2wpIHtcbiAgICAgICAgZm9ybS5zZXRDb250cm9sKDxzdHJpbmc+a2V5LCBmb3JtQ29udHJvbCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRWYWxpZGF0aW9uKG9wdDogc3RyaW5nLCB2YWx1ZTogYW55KSB7XG4gICAgc3dpdGNoIChvcHQpIHtcbiAgICAgIGNhc2UgJ3JlcXVpcmVkJzpcbiAgICAgICAgcmV0dXJuIFZhbGlkYXRvcnMucmVxdWlyZWQ7XG4gICAgICBjYXNlICdwYXR0ZXJuJzpcbiAgICAgICAgcmV0dXJuIFZhbGlkYXRvcnMucGF0dGVybih2YWx1ZSk7XG4gICAgICBjYXNlICdtaW5MZW5ndGgnOlxuICAgICAgICByZXR1cm4gVmFsaWRhdG9ycy5taW5MZW5ndGgodmFsdWUpO1xuICAgICAgY2FzZSAnbWF4TGVuZ3RoJzpcbiAgICAgICAgcmV0dXJuIFZhbGlkYXRvcnMubWF4TGVuZ3RoKHZhbHVlKTtcbiAgICAgIGNhc2UgJ21pbic6XG4gICAgICAgIHJldHVybiBWYWxpZGF0b3JzLm1pbih2YWx1ZSk7XG4gICAgICBjYXNlICdtYXgnOlxuICAgICAgICByZXR1cm4gVmFsaWRhdG9ycy5tYXgodmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgd3JhcE5nVmFsaWRhdG9yRm4oZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnLCB2YWxpZGF0b3I6IHN0cmluZyB8IEZpZWxkVmFsaWRhdG9yRm4pIHtcbiAgICB2YWxpZGF0b3IgPSB0eXBlb2YgdmFsaWRhdG9yID09PSAnc3RyaW5nJ1xuICAgID8gdGhpcy5mb3JtbHlDb25maWcuZ2V0VmFsaWRhdG9yKHZhbGlkYXRvcikudmFsaWRhdGlvblxuICAgIDogdmFsaWRhdG9yO1xuXG4gICAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpID0+ICh2YWxpZGF0b3IgYXMgRmllbGRWYWxpZGF0b3JGbikoY29udHJvbCwgZmllbGQpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0RmllbGRXcmFwcGVycyhmaWVsZDogRm9ybWx5RmllbGRDb25maWcpIHtcbiAgICBjb25zdCB0ZW1wbGF0ZU1hbmlwdWxhdG9yczogVGVtcGxhdGVNYW5pcHVsYXRvcnMgPSB7XG4gICAgICBwcmVXcmFwcGVyOiBbXSxcbiAgICAgIHBvc3RXcmFwcGVyOiBbXSxcbiAgICB9O1xuXG4gICAgaWYgKGZpZWxkLnRlbXBsYXRlT3B0aW9ucykge1xuICAgICAgdGhpcy5tZXJnZVRlbXBsYXRlTWFuaXB1bGF0b3JzKHRlbXBsYXRlTWFuaXB1bGF0b3JzLCBmaWVsZC50ZW1wbGF0ZU9wdGlvbnMudGVtcGxhdGVNYW5pcHVsYXRvcnMpO1xuICAgIH1cblxuICAgIHRoaXMubWVyZ2VUZW1wbGF0ZU1hbmlwdWxhdG9ycyh0ZW1wbGF0ZU1hbmlwdWxhdG9ycywgdGhpcy5mb3JtbHlDb25maWcudGVtcGxhdGVNYW5pcHVsYXRvcnMpO1xuICAgIGlmICghZmllbGQud3JhcHBlcnMpIHtcbiAgICAgIGZpZWxkLndyYXBwZXJzID0gW107XG4gICAgfVxuXG4gICAgY29uc3QgcHJlV3JhcHBlcnMgPSB0ZW1wbGF0ZU1hbmlwdWxhdG9ycy5wcmVXcmFwcGVyXG4gICAgICAubWFwKG0gPT4gbShmaWVsZCkpXG4gICAgICAuZmlsdGVyKHdyYXBwZXIgPT4gd3JhcHBlciAmJiBmaWVsZC53cmFwcGVycy5pbmRleE9mKHdyYXBwZXIpID09PSAtMSk7XG5cbiAgICBjb25zdCBwb3N0V3JhcHBlcnMgPSB0ZW1wbGF0ZU1hbmlwdWxhdG9ycy5wb3N0V3JhcHBlclxuICAgICAgLm1hcChtID0+IG0oZmllbGQpKVxuICAgICAgLmZpbHRlcih3cmFwcGVyID0+IHdyYXBwZXIgJiYgZmllbGQud3JhcHBlcnMuaW5kZXhPZih3cmFwcGVyKSA9PT0gLTEpO1xuXG4gICAgZmllbGQud3JhcHBlcnMgPSBbLi4ucHJlV3JhcHBlcnMsIC4uLmZpZWxkLndyYXBwZXJzLCAuLi5wb3N0V3JhcHBlcnNdO1xuICB9XG5cbiAgcHJpdmF0ZSBtZXJnZVRlbXBsYXRlTWFuaXB1bGF0b3JzKHNvdXJjZTogVGVtcGxhdGVNYW5pcHVsYXRvcnMsIHRhcmdldDogVGVtcGxhdGVNYW5pcHVsYXRvcnMpIHtcbiAgICB0YXJnZXQgPSB0YXJnZXQgfHwge307XG4gICAgaWYgKHRhcmdldC5wcmVXcmFwcGVyKSB7XG4gICAgICBzb3VyY2UucHJlV3JhcHBlciA9IHNvdXJjZS5wcmVXcmFwcGVyLmNvbmNhdCh0YXJnZXQucHJlV3JhcHBlcik7XG4gICAgfVxuICAgIGlmICh0YXJnZXQucG9zdFdyYXBwZXIpIHtcbiAgICAgIHNvdXJjZS5wb3N0V3JhcHBlciA9IHNvdXJjZS5wb3N0V3JhcHBlci5jb25jYXQodGFyZ2V0LnBvc3RXcmFwcGVyKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc291cmNlO1xuICB9XG59XG4iXX0=